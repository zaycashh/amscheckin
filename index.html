<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      margin: 0;
      padding: 0;
      background: #f5f5f5;
      color: #222;
    }
    header {
      background: #ffffff;
      border-bottom: 4px solid #4F8C47;
      padding: 10px 16px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
    }
    .header-left {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .header-logo {
      height: 52px;
      border-radius: 6px;
      overflow: hidden;
      box-shadow: 0 1px 3px rgba(0,0,0,0.2);
    }
    .header-logo img {
      height: 100%;
      width: auto;
      display: block;
    }
    .header-text-main {
      font-size: 1.1rem;
      font-weight: 700;
      color: #D9A441;
      line-height: 1.2;
    }
    .header-text-sub {
      font-size: 0.85rem;
      color: #4F8C47;
    }
    .header-tagline {
      font-size: 0.75rem;
      color: #1E3A59;
      font-style: italic;
      text-align: right;
      max-width: 180px;
    }
    main {
      padding: 12px;
      max-width: 960px;
      margin: 0 auto;
    }
    .card {
      background: white;
      border-radius: 10px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.08);
      padding: 14px;
      margin-bottom: 14px;
      border-top: 3px solid #D9A441;
    }
    h2 {
      font-size: 1.05rem;
      margin-top: 0;
      color: #1E3A59;
    }
    label {
      display: block;
      margin-top: 8px;
      font-size: 0.9rem;
      font-weight: 500;
    }
    input, button, select {
      width: 100%;
      box-sizing: border-box;
      padding: 10px;
      margin-top: 4px;
      border-radius: 8px;
      border: 1px solid #ccc;
      font-size: 1rem;
    }
    button {
      background: #4F8C47;
      color: white;
      border: none;
      font-weight: 600;
      cursor: pointer;
      margin-top: 10px;
    }
    button.secondary {
      background: #1E3A59;
    }
    button:active {
      opacity: 0.85;
    }
    .row {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
    }
    .col-4 {
      flex: 1 1 30%;
    }
    .col-6 {
      flex: 1 1 48%;
    }
    .col-12 {
      flex: 1 1 100%;
    }
    @media (max-width: 600px) {
      .col-4, .col-6 {
        flex: 1 1 100%;
      }
      .header-tagline {
        display: none;
      }
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
      font-size: 0.9rem;
    }
    th, td {
      border: 1px solid #ddd;
      padding: 6px;
      text-align: left;
      white-space: nowrap;
    }
    th {
      background: #f0f0f0;
    }
    .badge {
      display: inline-block;
      padding: 2px 6px;
      border-radius: 999px;
      font-size: 0.75rem;
      background: #e3f2fd;
      color: #1E3A59;
      margin-left: 4px;
    }
    .small-text {
      font-size: 0.8rem;
      color: #666;
    }
    .actions-row {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-top: 8px;
    }
    .actions-row button {
      flex: 1 1 48%;
    }
    .pill-row {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-top: 6px;
    }
    .pill {
      padding: 4px 10px;
      border-radius: 999px;
      border: 1px solid #4F8C47;
      background: #eaf5ec;
      font-size: 0.8rem;
      cursor: pointer;
      color: #1E3A59;
    }
    .summary-box {
      margin-top: 8px;
      padding: 8px;
      border-radius: 8px;
      background: #f7f9fc;
      border: 1px solid #dde4f2;
      font-size: 0.9rem;
    }
    .tag-list {
      font-size: 0.8rem;
      margin-top: 6px;
      color: #555;
    }
    .admin-toggle-row {
      text-align: right;
      margin-bottom: 6px;
    }
    .admin-toggle-btn {
      width: auto;
      padding: 6px 10px;
      font-size: 0.75rem;
      background: #1E3A59;
    }
    #signatureWrapper {
      position: relative;
      margin-top: 6px;
    }
    #signaturePad {
      width: 100%;
      height: 140px;
      border-radius: 8px;
      border: 1px solid #ccc;
      background: #ffffff;
      touch-action: none;
      display: block;
    }
    #sigPlaceholder {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      color: #888;
      font-size: 16px;
      pointer-events: none;
    }
    .sig-btn {
      width: auto;
      padding: 4px 8px;
      font-size: 0.75rem;
      background: #4F8C47;
      color: #fff;
      border-radius: 999px;
      border: none;
      cursor: pointer;
    }
  </style>

  <script>
    // Soft clinic-style ding on submit
    function playSubmitSound() {
      var audio = new Audio("data:audio/wav;base64,UklGRoQAAABXQVZFZm10IBAAAAABAAEAESsAACJWAAACABAAZGF0YQwAAACAgICAgICAgICAgICAhISEhISEhISEhICAhISEhISEhISEhICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAg");
      audio.volume = 0.35;
      audio.play().catch(e=>console.log(e));
    }
    
    function resetForm() {
    // Clear all text inputs
    document.querySelectorAll('input[type="text"]').forEach(i => i.value = "");

    // Reset dropdowns
    document.querySelectorAll("select").forEach(s => s.selectedIndex = 0);

    // Clear ALL checkboxes (service checkboxes + "other")
    document.querySelectorAll('.service-options input[type="checkbox"]').forEach(cb => cb.checked = false);

    // Hide "Other Company" field
    const otherCompanyWrapper = document.getElementById("otherCompanyWrapper");
    const otherCompanyInput = document.getElementById("otherCompany");
    if (otherCompanyWrapper) otherCompanyWrapper.style.display = "none";
    if (otherCompanyInput) otherCompanyInput.value = "";

    // Hide "Other Reason" field
    const otherReasonWrapper = document.getElementById("otherReasonWrapper");
    const otherReasonInput = document.getElementById("otherReasonInput");
    if (otherReasonWrapper) otherReasonWrapper.style.display = "none";
    if (otherReasonInput) otherReasonInput.value = "";

    // Clear signature pad
    const clearBtn = document.getElementById("clearSigBtn");
    if (clearBtn) clearBtn.click();

    // Clear status message
    const msg = document.getElementById("submitMessage");
    if (msg) msg.textContent = "";

    alert("Form has been reset.");
}

  </script>
</head>
<body>
  <header>
    <div class="header-left">
      <div class="header-logo">
        <img src="ams_logo_cropped.jpg" alt="AMS logo" />
      </div>
      <div>
        <div class="header-text-main">AMS Check-In</div>
        <div class="header-text-sub">airport medical solutions</div>
      </div>
    </div>
    <div class="header-tagline">Your One Stop Compliance Shop</div>
  </header>
  <main>
    <!-- Public: New Check-In (donors/employees see this only) -->
    <section class="card">
      <h2>Check-In</h2>
      <div class="row">
        <div class="col-6">
          <label for="firstName">First Name</label>
          <input id="firstName" type="text" autocomplete="off" required />
        </div>
        <div class="col-6">
          <label for="lastName">Last Name</label>
          <input id="lastName" type="text" autocomplete="off" required />
        </div>
      </div>

      <div class="row">
        <div class="col-6">
          <label for="companySelect">Company (Employer)</label>
          <select id="companySelect" onchange="toggleOtherCompany()">
          </select>
          <div class="col-6" id="otherCompanyWrapper" style="display:none; margin-top:10px;">
    <label for="otherCompany">Other Company (type manually)</label>
    <input id="otherCompany" type="text" placeholder="Enter company name..." autocomplete="off" />
</div>
        
          <!-- END of Company Row -->

<!-- PASTE SERVICE CHECKBOXES HERE -->
<div class="service-options" style="margin-top:15px;">
    <label style="font-weight:bold;">Service Type</label>

    <!-- Row 1 -->
    <div style="display:flex; gap:25px; margin-top:10px; align-items:center;">
        <label><input type="checkbox" name="service_drug"> Drug Test</label>
        <label><input type="checkbox" name="service_dna"> DNA Paternity Test</label>
        <label><input type="checkbox" name="service_vision"> Vision Test</label>
    </div>

    <!-- Row 2 -->
    <div style="display:flex; gap:25px; margin-top:10px; align-items:center;">
        <label><input type="checkbox" name="service_alcohol"> Alcohol Test</label>
        <label><input type="checkbox" name="service_dot"> DOT Physical</label>

        <label>
            <input type="checkbox" id="service_other" onclick="toggleOtherInput()"> Other
        </label>

        <input
            type="text"
            id="other_reason"
            placeholder="Enter reason..."
            style="display:none; padding:4px; border:1px solid #ccc; border-radius:5px;"
        />
    </div>
</div> 

<!-- END OF SERVICE CHECKBOXES -->

      <label for="reasonSelect">Reason for Testing</label>
      <select id="reasonSelect" onchange="toggleOtherReason()">
        <option value="">-- Select reason --</option>
        <option value="Pre-employment">Pre-employment</option>
        <option value="Random">Random</option>
        <option value="Reasonable suspicion">Reasonable suspicion</option>
        <option value="Post-accident">Post-accident</option>
        <option value="Return to duty">Return to duty</option>
        <option value="Follow up">Follow up</option>
        <option value="Other (personal)">Other (personal)</option>
      </select>
      <div id="otherReasonWrapper" style="display:none; margin-top:10px;">
          <label for="otherReasonInput">Other Reason (type manually)</label>
          <input id="otherReasonInput" type="text" placeholder="Enter other reason..." autocomplete="off" />
      </div>

      <label for="signaturePad">Donor Signature</label>
      <div id="signatureWrapper">
        <canvas id="signaturePad"></canvas>
        <div id="sigPlaceholder">Sign here</div>
      </div>
      <button type="button" id="clearSigBtn" class="secondary" style="width:auto; padding:6px 10px; font-size:0.8rem; margin-top:6px;">Clear Signature</button>

      <p class="small-text">
        Donor must sign above. Date &amp; time in are recorded automatically when you tap "Submit Check-In".
      </p>

      <div style="display:flex; gap:10px; margin-top:10px;">

    <!-- Submit Button (unchanged) -->
    <button id="submitBtn" style="flex:1;">
        Submit Check-In
    </button>

    <!-- Reset Button (RED) -->
    <button type="button"
            onclick="resetForm()"
            style="
                flex:1;
                background:#d9534f;
                color:white;
                padding:12px;
                border:none;
                border-radius:6px;
                font-size:1rem;
                cursor:pointer;">
        Reset Form
    </button>

</div>

      <p id="submitMessage" class="small-text"></p>
    </section>

    <!-- Small admin login control -->
    <div class="admin-toggle-row">
      <button id="toggleAdminBtn" class="admin-toggle-btn">Admin Login</button>
      <span class="small-text" id="adminStatusText"></span>
    </div>

    <!-- ADMIN-ONLY AREA (hidden until PIN is entered) -->
    <div id="adminArea" style="display:none;">
      <!-- Search Log -->
      <section class="card">
        <h2>Search For Individual</h2>
        <div class="row">
          <div class="col-4">
            <label for="searchName">Donor Name</label>
            <input id="searchName" type="text" placeholder="first or last name" />
          </div>
          <div class="col-4">
            <label for="searchCompany">Company Name</label>
            <input id="searchCompany" type="text" placeholder="e.g. ABC Logistics" />
          </div>
          <div class="col-4">
            <label for="searchDate">Date</label>
            <input id="searchDate" type="date" />
          </div>
        </div>
        <div class="row">
          <div class="col-6">
            <label for="searchReason">Reason for Test</label>
            <select id="searchReason">
              <option value="">Any reason</option>
              <option value="Pre-employment">Pre-employment</option>
              <option value="Random">Random</option>
              <option value="Reasonable suspicion">Reasonable suspicion</option>
              <option value="Post-accident">Post-accident</option>
              <option value="Return to duty">Return to duty</option>
              <option value="Follow up">Follow up</option>
              <option value="Other (personal)">Other (personal)</option>
            </select>
          </div>
        </div>
        <div class="actions-row">
          <button id="searchBtn">Search</button>
          <button id="clearFilterBtn" class="secondary">Clear Filters</button>
        </div>
        <p class="small-text">For AMS internal use only (billing, audits, etc.).</p>
        <div style="overflow-x:auto;">
          <table id="resultsTable">
            <thead>
              <tr>
                <th>Date</th>
                <th>Time In</th>
                <th>First</th>
                <th>Last</th>
                <th>Company</th>
                <th>Reason</th>
                <th>Services</th>
                <th>Signature</th>
              </tr>
            </thead>
            <tbody>
            </tbody>
          </table>
        </div>
        <div class="actions-row">
          <button id="exportExcelBtn">Export Results to Excel</button>
          <button id="exportPdfBtn">Export Results to PDF</button>
        </div>
      </section>

      <!-- Reports -->
      <section class="card">
        <h2>Detail Company Report</h2>
        <!-- DATE PRESETS -->
<div class="pill-row" style="margin-top:10px;">
    <span class="pill" data-companyrange="today">Today</span>
    <span class="pill" data-companyrange="yesterday">Yesterday</span>

    <span class="pill" data-companyrange="thisWeek">This Week</span>
    <span class="pill" data-companyrange="lastWeek">Last Week</span>

    <span class="pill" data-companyrange="thisMonth">This Month</span>
    <span class="pill" data-companyrange="lastMonth">Last Month</span>

    <span class="pill" data-companyrange="thisYear">This Year</span>
    <span class="pill" data-companyrange="lastYear">Last Year</span>
  <span class="pill" data-companyrange="custom">Custom Range</span>
</div>

        <div class="row">
          <div class="col-6">
            <label for="reportStart">Start Date</label>
            <input id="reportStart" type="date" />
          </div>
          <div class="col-6">
            <label for="reportEnd">End Date</label>
            <input id="reportEnd" type="date" />
          </div>
        </div>
        
        <div class="row">
          <div class="col-6">
            <label for="reportCompany">Company (optional)</label>
            <input id="reportCompany" type="text" placeholder="filter to one company" />
          </div>
          <div class="col-6">
            <label for="reportName">Donor Name (optional)</label>
            <input id="reportName" type="text" placeholder="first or last name" />
          </div>
        </div>
        <div class="row">
          <div class="col-6">
            <label for="reportReason">Reason (optional)</label>
            <select id="reportReason">
              <option value="">Any reason</option>
              <option value="Pre-employment">Pre-employment</option>
              <option value="Random">Random</option>
              <option value="Reasonable suspicion">Reasonable suspicion</option>
              <option value="Post-accident">Post-accident</option>
              <option value="Return to duty">Return to duty</option>
              <option value="Follow up">Follow up</option>
              <option value="Other (personal)">Other (personal)</option>
            </select>
          </div>
        </div>
        <div class="actions-row">
          <button id="runReportBtn">Run Report</button>
          <button id="clearReportBtn" class="secondary">Clear Report Filters</button>
        </div>

        <div id="reportSummary" class="summary-box" style="display:none;"></div>

        <div style="overflow-x:auto; margin-top:8px;">
          <table id="reportTable">
            <thead>
              <tr>
                <th>Date</th>
                <th>Time In</th>
                <th>First</th>
                <th>Last</th>
                <th>Company</th>
                <th>Reason</th>
                <th>Signature</th>
              </tr>
            </thead>
            <tbody>
            </tbody>
          </table>
        </div>

        <div class="actions-row">
          <button id="exportReportXlsBtn" class="secondary">Export REPORT as Excel (.xls)</button>
          <button id="printReportBtn" class="secondary">Print REPORT (PDF)</button>
        </div>
      </section>
    
      <!-- Recent Check-Ins -->
      <section class="card">
        <h2>Recent Check-Ins <span class="badge" id="countBadge">0</span></h2>
        <div style="overflow-x:auto;">
          <table id="recentTable">
            <thead>
              <tr>
                <th>Date</th>
                <th>Time In</th>
                <th>First</th>
                <th>Last</th>
                <th>Company</th>
                <th>Reason</th>
                <th>Signature</th>
              </tr>
            </thead>
            <tbody>
            </tbody>
          </table>
        </div>
      </section>

      <!-- Admin: Manage Companies -->
      <section class="card">
        <h2>Manage Company List (Admin)</h2>
        <div class="row">
          <div class="col-6">
            <label for="newCompany">Add Company Name</label>
            <input id="newCompany" type="text" placeholder="e.g. ABC Logistics" />
          </div>
          <div class="col-6" style="display:flex; align-items:flex-end;">
            <button id="addCompanyBtn">Add to List</button>
          </div>
        </div>
        <p class="small-text">
    These companies appear in the dropdown for donors. You can add, edit, delete, or search companies below.
</p>

<!-- ðŸ” Search bar -->
<input 
    type="text" 
    id="companySearch" 
    placeholder="Search company..." 
    style="width: 100%; padding: 6px; margin-bottom: 10px;"
/>

<!-- Company List Display -->
<div id="companyListDisplay" class="tag-list"></div>

  </main>

        <script>
/* -------------------------------------------------------
   BASIC UTILITIES
------------------------------------------------------- */
function playSubmitSound() {
  var audio = new Audio("data:audio/wav;base64,UklGRoQAAABXQVZFZm10IBAAAAABAAEAESsAACJWAAACABAAZGF0YQwAAACAgICAgICAgICAgICAhISEhISEhISEhICAhISEhISEhISEhICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAg");
  audio.volume = 0.35;
  audio.play().catch(e=>console.log(e));
}

function resetForm() {
  document.querySelectorAll('input[type="text"]').forEach(i => i.value = "");
  document.querySelectorAll("select").forEach(s => s.selectedIndex = 0);
  document.querySelectorAll('.service-options input[type="checkbox"]').forEach(cb => cb.checked = false);

  const otherCompanyWrapper = document.getElementById("otherCompanyWrapper");
  const otherCompanyInput = document.getElementById("otherCompany");
  otherCompanyWrapper.style.display = "none";
  otherCompanyInput.value = "";

  const otherReasonWrapper = document.getElementById("otherReasonWrapper");
  const otherReasonInput = document.getElementById("otherReasonInput");
  otherReasonWrapper.style.display = "none";
  otherReasonInput.value = "";

  const clearBtn = document.getElementById("clearSigBtn");
  if (clearBtn) clearBtn.click();

  const msg = document.getElementById("submitMessage");
  if (msg) msg.textContent = "";

  alert("Form has been reset.");
}

/* -------------------------------------------------------
   STORAGE
------------------------------------------------------- */
const STORAGE_KEY = 'drug_test_checkins_v2';
const COMPANY_LIST_KEY = 'drug_test_company_list_v1';
const OTHER_COMPANY_VALUE = '__OTHER__';
const ADMIN_PIN = "2468";

let signatureStore = {};
let adminUnlocked = false;

function loadRecords() {
  try {
    return JSON.parse(localStorage.getItem(STORAGE_KEY)) || [];
  } catch {
    return [];
  }
}
function saveRecords(arr) {
  localStorage.setItem(STORAGE_KEY, JSON.stringify(arr));
}
function addRecord(r) {
  const arr = loadRecords();
  arr.push(r);
  saveRecords(arr);
}

/* -------------------------------------------------------
   DATE + TIME FORMATTERS
------------------------------------------------------- */
function getLocalDateString(d) {
  return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
}
function formatDateTime(iso) {
  const d = new Date(iso);
  if (isNaN(d)) return {date:"", time:""};
  return {
    date: d.toLocaleDateString(),
    time: d.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})
  };
}

/* -------------------------------------------------------
   SERVICE FORMATTER
------------------------------------------------------- */
function formatServices(s) {
  if (!s) return "";
  let list = [];
  if (s.drug) list.push("Drug Test");
  if (s.dna) list.push("DNA");
  if (s.vision) list.push("Vision");
  if (s.alcohol) list.push("Alcohol");
  if (s.dot) list.push("DOT Physical");
  if (s.other && s.otherText) list.push("Other: " + s.otherText);
  return list.join(", ");
}

/* -------------------------------------------------------
   SIGNATURE PAD
------------------------------------------------------- */
function setupSignaturePad() {
  const canvas = document.getElementById("signaturePad");
  const placeholder = document.getElementById("sigPlaceholder");
  const ctx = canvas.getContext("2d");

  function resize() {
    const rect = canvas.getBoundingClientRect();
    canvas.width = rect.width;
    canvas.height = rect.height;
  }
  resize();
  window.addEventListener("resize", resize);

  let drawing = false, lastX=0, lastY=0, hasSig = false;

  function pos(e) {
    const rect = canvas.getBoundingClientRect();
    const x = (e.touches ? e.touches[0].clientX : e.clientX) - rect.left;
    const y = (e.touches ? e.touches[0].clientY : e.clientY) - rect.top;
    return {x,y};
  }

  function start(e){
    e.preventDefault();
    drawing = true;
    let p = pos(e);
    lastX=p.x; lastY=p.y;
    placeholder.style.display="none";
  }
  function draw(e){
    if(!drawing) return;
    e.preventDefault();
    let p = pos(e);
    ctx.strokeStyle="#000";
    ctx.lineWidth=2;
    ctx.lineCap="round";
    ctx.beginPath();
    ctx.moveTo(lastX,lastY);
    ctx.lineTo(p.x,p.y);
    ctx.stroke();
    lastX=p.x; lastY=p.y;
    hasSig=true;
  }
  function stop(e){ drawing=false; }

  canvas.addEventListener("mousedown",start);
  canvas.addEventListener("mousemove",draw);
  window.addEventListener("mouseup",stop);

  canvas.addEventListener("touchstart",start,{passive:false});
  canvas.addEventListener("touchmove",draw,{passive:false});
  canvas.addEventListener("touchend",stop);

  document.getElementById("clearSigBtn").onclick = function(){
    ctx.clearRect(0,0,canvas.width,canvas.height);
    hasSig=false;
    placeholder.style.display="block";
  };

  return {
    hasSignature: ()=>hasSig,
    getDataUrl: ()=> hasSig ? canvas.toDataURL("image/png") : "",
    clear: ()=> {
      ctx.clearRect(0,0,canvas.width,canvas.height);
      hasSig=false;
      placeholder.style.display="block";
    }
  };
}

/* -------------------------------------------------------
   COMPANY LIST MANAGER
------------------------------------------------------- */
function loadCompanyList(){
  try { return JSON.parse(localStorage.getItem(COMPANY_LIST_KEY))||[]; }
  catch { return []; }
}
function saveCompanyList(list){
  localStorage.setItem(COMPANY_LIST_KEY, JSON.stringify(list));
}

function renderCompanySelect(){
  const list = loadCompanyList();
  const sel = document.getElementById("companySelect");
  sel.innerHTML = `<option value="">-- Select company --</option>`;
  list.forEach(c=>{
    sel.innerHTML += `<option value="${c}">${c}</option>`;
  });
  sel.innerHTML += `<option value="${OTHER_COMPANY_VALUE}">Other (type manually)</option>`;
}

function renderCompanyListDisplay(){
  let list = loadCompanyList();
  const search = document.getElementById("companySearch").value.toLowerCase();
  const box = document.getElementById("companyListDisplay");

  const filtered = list.filter(c=>c.toLowerCase().includes(search));

  box.innerHTML = filtered.map(c=>`
    <div style="display:flex;justify-content:space-between;align-items:center;margin:4px 0;">
      <span>${c}</span>
      <div>
        <button class="editCompanyBtn" data-name="${c}">Edit</button>
        <button class="deleteCompanyBtn" data-name="${c}" style="background:#d9534f;color:white;">Delete</button>
      </div>
    </div>
  `).join("");

  document.querySelectorAll(".editCompanyBtn").forEach(btn=>{
    btn.onclick = ()=>{
      const old = btn.dataset.name;
      const newer = prompt("Rename company:", old);
      if(!newer) return;
      if(list.includes(newer) && newer!==old){
        alert("That company already exists.");
        return;
      }
      list[list.indexOf(old)] = newer;
      list.sort();
      saveCompanyList(list);
      renderCompanySelect();
      renderCompanyListDisplay();
    };
  });

  document.querySelectorAll(".deleteCompanyBtn").forEach(btn=>{
    btn.onclick = ()=>{
      const name = btn.dataset.name;
      if(!confirm("Delete " + name + "?")) return;
      list = list.filter(x=>x!==name);
      saveCompanyList(list);
      renderCompanySelect();
      renderCompanyListDisplay();
    };
  });
}

/* -------------------------------------------------------
   SEARCH
------------------------------------------------------- */
function runSearch(){
  const nameInput = document.getElementById("searchName").value.trim().toLowerCase();
  const parts = nameInput.split(" ").filter(x=>x);
  const comp = document.getElementById("searchCompany").value.trim().toLowerCase();
  const date = document.getElementById("searchDate").value;
  const reason = document.getElementById("searchReason").value;

  const out = document.querySelector("#resultsTable tbody");
  out.innerHTML="";

  const recs = loadRecords();

  const filtered = recs.filter(r=>{

    let ok = true;

    let fn = r.firstName.toLowerCase();
    let ln = r.lastName.toLowerCase();

    if(parts.length===1){
      ok = ok && (fn.includes(parts[0]) || ln.includes(parts[0]));
    }
    if(parts.length===2){
      ok = ok && (
        (fn.includes(parts[0]) && ln.includes(parts[1])) ||
        (fn.includes(parts[1]) && ln.includes(parts[0]))
      );
    }

    if(comp){
      ok = ok && r.company.toLowerCase().includes(comp);
    }

    if(date){
      let d = new Date(r.timestamp);
      if(getLocalDateString(d)!==date) ok = false;
    }

    if(reason){
      if(reason.includes("Other")){
        const presets = ["Pre-employment","Random","Reasonable suspicion","Post-accident","Return to duty","Follow up"];
        if(presets.includes(r.reason)) ok=false;
      } else {
        if(r.reason!==reason) ok=false;
      }
    }

    return ok;
  });

  filtered.sort((a,b)=> new Date(a.timestamp)-new Date(b.timestamp));

  filtered.forEach(r=>{
    const dt = formatDateTime(r.timestamp);
    signatureStore[r.id] = r.signatureDataUrl;

    out.innerHTML += `
      <tr>
        <td>${dt.date}</td>
        <td>${dt.time}</td>
        <td>${r.firstName}</td>
        <td>${r.lastName}</td>
        <td>${r.company}</td>
        <td>${r.reason}</td>
        <td>${formatServices(r.serviceTypes)}</td>
        <td>${r.signatureDataUrl ? `<button class="sig-btn" data-sigid="${r.id}">View</button>`:""}</td>
      </tr>
    `;
  });
}

/* -------------------------------------------------------
   SEARCH EXPORTS
------------------------------------------------------- */
function exportSearchResultsToExcel(){
  const rows = [...document.querySelectorAll("#resultsTable tr")];
  let arr = [];
  rows.forEach((row,i)=>{
    if(i===0) return;
    const c = [...row.querySelectorAll("td")];
    arr.push({
      firstName:c[2]?.innerText||"",
      lastName:c[3]?.innerText||"",
      company:c[4]?.innerText||"",
      reason:c[5]?.innerText||""
    });
  });

  let html = "<table><tr><th>First</th><th>Last</th><th>Company</th><th>Reason</th></tr>";
  arr.forEach(r=>{
    html += `<tr><td>${r.firstName}</td><td>${r.lastName}</td><td>${r.company}</td><td>${r.reason}</td></tr>`;
  });
  html+="</table>";

  const blob = new Blob(["\ufeff"+html],{type:"application/vnd.ms-excel"});
  const a = document.createElement("a");
  a.href=URL.createObjectURL(blob);
  a.download="search_results.xls";
  a.click();
}

function exportSearchResultsToPDF(){
  const table = document.querySelector('#resultsTable');
  let html = `
    <html><head><style>
    table{border-collapse:collapse;width:100%;}
    th,td{border:1px solid #333;padding:6px;}
    </style></head><body>
    <h2>Search Results</h2>
    ${table.outerHTML}
    </body></html>
  `;
  const blob=new Blob([html],{type:"application/pdf"});
  const url=URL.createObjectURL(blob);
  const a=document.createElement("a");
  a.href=url;
  a.download="search_results.pdf";
  a.click();
  URL.revokeObjectURL(url);
}

/* -------------------------------------------------------
   RECENT TABLE
------------------------------------------------------- */
function refreshRecentTable(){
  const out=document.querySelector("#recentTable tbody");
  const badge=document.getElementById("countBadge");

  const recs = loadRecords().sort((a,b)=>new Date(b.timestamp)-new Date(a.timestamp));
  badge.textContent=recs.length;

  out.innerHTML="";
  recs.slice(0,20).forEach(r=>{
    const dt=formatDateTime(r.timestamp);
    signatureStore[r.id]=r.signatureDataUrl;
    out.innerHTML += `
      <tr>
        <td>${dt.date}</td>
        <td>${dt.time}</td>
        <td>${r.firstName}</td>
        <td>${r.lastName}</td>
        <td>${r.company}</td>
        <td>${r.reason}</td>
        <td>${formatServices(r.serviceTypes)}</td>
        <td>${r.signatureDataUrl?`<button class="sig-btn" data-sigid="${r.id}">View</button>`:""}</td>
      </tr>`;
  });
}

/* -------------------------------------------------------
   DETAILED COMPANY REPORT (THE ONE YOU CHOSE â€” VERSION A)
------------------------------------------------------- */
let lastCompanyReport = [];
let lastCompanySummary = "";

function applyCompanyDatePreset(preset){
  const start=document.getElementById("companyReportStart");
  const end=document.getElementById("companyReportEnd");
  const today=new Date();
  let s=new Date(), e=new Date();

  switch(preset){
    case "today": break;
    case "yesterday": s.setDate(s.getDate()-1); e.setDate(e.getDate()-1); break;
    case "thisWeek": s.setDate(s.getDate()-s.getDay()); break;
    case "lastWeek":
      s.setDate(s.getDate()-s.getDay()-7);
      e = new Date(s);
      e.setDate(s.getDate()+6);
      break;
    case "thisMonth":
      s=new Date(today.getFullYear(),today.getMonth(),1);
      break;
    case "lastMonth":
      s=new Date(today.getFullYear(),today.getMonth()-1,1);
      e=new Date(today.getFullYear(),today.getMonth(),0);
      break;
    case "thisYear":
      s=new Date(today.getFullYear(),0,1);
      break;
    case "lastYear":
      s=new Date(today.getFullYear()-1,0,1);
      e=new Date(today.getFullYear()-1,11,31);
      break;
  }

  start.value=s.toISOString().split("T")[0];
  end.value=e.toISOString().split("T")[0];
}

function runCompanyReport(){
  const drop = document.getElementById("companyReportSelect").value.trim().toLowerCase();
  const manual = document.getElementById("companyReportManual").value.trim().toLowerCase();
  const comp = manual || drop;

  if(!comp){ alert("Select or type a company name."); return; }

  const start=document.getElementById("companyReportStart").value;
  const end=document.getElementById("companyReportEnd").value;
  if(!start || !end){ alert("Select a date range."); return; }

  const sDate=new Date(start+"T00:00:00");
  const eDate=new Date(end+"T23:59:59");

  const out=document.querySelector("#companyReportTable tbody");
  out.innerHTML="";

  const recs = loadRecords().filter(r=>{
    const d=new Date(r.timestamp);
    return d>=sDate && d<=eDate && r.company.toLowerCase().includes(comp);
  });

  recs.sort((a,b)=> new Date(a.timestamp)-new Date(b.timestamp));

  recs.forEach(r=>{
    const dt=formatDateTime(r.timestamp);
    signatureStore[r.id]= r.signatureDataUrl;
    out.innerHTML += `
      <tr>
        <td>${dt.date}</td>
        <td>${dt.time}</td>
        <td>${r.firstName}</td>
        <td>${r.lastName}</td>
        <td>${r.reason}</td>
        <td>${formatServices(r.serviceTypes)}</td>
        <td>${r.signatureDataUrl?`<button class="sig-btn" data-sigid="${r.id}">View</button>`:""}</td>
      </tr>`;
  });

  const summary=document.getElementById("companyReportSummary");
  summary.style.display="block";
  summary.textContent=`Company: ${comp.toUpperCase()} | Total: ${recs.length} | Range: ${start} â†’ ${end}`;

  lastCompanyReport=recs;
  lastCompanySummary=summary.textContent;
}

function exportCompanyXLS(){
  if(!lastCompanyReport.length){ alert("No data."); return; }

  let html="<table><tr><th>Date</th><th>Time</th><th>First</th><th>Last</th><th>Reason</th><th>Services</th></tr>";
  lastCompanyReport.forEach(r=>{
    const dt=formatDateTime(r.timestamp);
    html+=`<tr>
      <td>${dt.date}</td>
      <td>${dt.time}</td>
      <td>${r.firstName}</td>
      <td>${r.lastName}</td>
      <td>${r.reason}</td>
      <td>${formatServices(r.serviceTypes)}</td>
    </tr>`;
  });
  html+="</table>";

  const blob=new Blob(["\ufeff"+html],{type:"application/vnd.ms-excel"});
  const a=document.createElement("a");
  a.href=URL.createObjectURL(blob);
  a.download="company_report.xls";
  a.click();
}

function printCompanyPDF(){
  if(!lastCompanyReport.length){ alert("No data."); return; }

  let table="<table border='1' cellspacing='0' cellpadding='4'><tr><th>Date</th><th>Time</th><th>First</th><th>Last</th><th>Reason</th><th>Services</th></tr>";
  lastCompanyReport.forEach(r=>{
    const dt=formatDateTime(r.timestamp);
    table+=`<tr>
      <td>${dt.date}</td>
      <td>${dt.time}</td>
      <td>${r.firstName}</td>
      <td>${r.lastName}</td>
      <td>${r.reason}</td>
      <td>${formatServices(r.serviceTypes)}</td>
    </tr>`;
  });
  table+="</table>";

  const w=window.open();
  w.document.write(`<h2>Company Report</h2><p>${lastCompanySummary}</p>${table}`);
  w.print();
}

/* -------------------------------------------------------
   ADMIN TOGGLE
------------------------------------------------------- */
function toggleAdmin(){
  if(adminUnlocked){
    adminUnlocked=false;
    document.getElementById("adminArea").style.display="none";
    document.getElementById("toggleAdminBtn").textContent="Admin Login";
    return;
  }
  const pin=prompt("Enter admin PIN:");
  if(pin===ADMIN_PIN){
    adminUnlocked=true;
    document.getElementById("adminArea").style.display="block";
    document.getElementById("toggleAdminBtn").textContent="Hide Admin";
    refreshRecentTable();
  } else {
    alert("Incorrect PIN.");
  }
}

/* -------------------------------------------------------
   ON LOAD
------------------------------------------------------- */
document.addEventListener("DOMContentLoaded",()=>{

  if(!localStorage.getItem(COMPANY_LIST_KEY)) saveCompanyList([]);

  const sigPad = setupSignaturePad();
  renderCompanySelect();
  renderCompanyListDisplay();

  document.getElementById("companySelect").onchange = function(){
    if(this.value===OTHER_COMPANY_VALUE){
      document.getElementById("otherCompanyWrapper").style.display="block";
    } else {
      document.getElementById("otherCompanyWrapper").style.display="none";
      document.getElementById("otherCompany").value="";
    }
  };

  /* ------------------------------------------
     SUBMIT CHECK-IN
  ------------------------------------------ */
  document.getElementById("submitBtn").onclick = function(){

    const fn = document.getElementById("firstName").value.trim();
    const ln = document.getElementById("lastName").value.trim();
    const compSel = document.getElementById("companySelect").value;
    const compOther = document.getElementById("otherCompany").value.trim();
    const reasonSel = document.getElementById("reasonSelect").value;

    const msg=document.getElementById("submitMessage");

    if(!fn || !ln){
      msg.textContent="Enter first and last name.";
      msg.style.color="red"; return;
    }

    let company = compSel;
    if(compSel===OTHER_COMPANY_VALUE){
      if(!compOther){
        msg.textContent="Enter company name.";
        msg.style.color="red"; return;
      }
      company = compOther;
    }

    let reason = reasonSel;
    if(reasonSel.includes("Other")){
      const txt=document.getElementById("otherReasonInput").value.trim();
      if(!txt){
        msg.textContent="Enter other reason.";
        msg.style.color="red"; return;
      }
      reason = txt;
    }
    if(!reason){
      msg.textContent="Select testing reason.";
      msg.style.color="red"; return;
    }

    const otherCB = document.getElementById("service_other").checked;
    const otherTxt = document.getElementById("other_reason").value.trim();
    if(otherCB && !otherTxt){
      msg.textContent="Enter service 'Other' description.";
      msg.style.color="red"; return;
    }

    if(!sigPad.hasSignature()){
      msg.textContent="Signature required.";
      msg.style.color="red"; return;
    }

    const rec = {
      id: Date.now()+"",
      firstName: fn,
      lastName: ln,
      company: company,
      reason: reason,
      timestamp: new Date().toISOString(),
      signatureDataUrl: sigPad.getDataUrl(),
      serviceTypes:{
        drug: document.querySelector('input[name="service_drug"]').checked,
        dna: document.querySelector('input[name="service_dna"]').checked,
        vision: document.querySelector('input[name="service_vision"]').checked,
        alcohol: document.querySelector('input[name="service_alcohol"]').checked,
        dot: document.querySelector('input[name="service_dot"]').checked,
        other: otherCB,
        otherText: otherTxt
      }
    };

    addRecord(rec);
    sigPad.clear();

    document.getElementById("firstName").value="";
    document.getElementById("lastName").value="";
    document.getElementById("companySelect").value="";
    document.getElementById("otherCompany").value="";
    document.getElementById("otherCompanyWrapper").style.display="none";
    document.getElementById("reasonSelect").value="";
    document.getElementById("otherReasonInput").value="";
    document.getElementById("other_reason").value="";
    document.getElementById("other_reason").style.display="none";

    msg.textContent="Check-in Saved.";
    msg.style.color="green";

    playSubmitSound();
  };

  /* ------------------------------------------
     COMPANY ADD
  ------------------------------------------ */
  document.getElementById("addCompanyBtn").onclick = function(){
    const input=document.getElementById("newCompany");
    const name=input.value.trim();
    if(!name) return;

    let list=loadCompanyList();
    if(list.includes(name)){
      alert("Already exists."); return;
    }

    list.push(name);
    list.sort();
    saveCompanyList(list);
    renderCompanySelect();
    renderCompanyListDisplay();
    input.value="";
  };

  /* ------------------------------------------
     SEARCH / FILTERS
  ------------------------------------------ */
  document.getElementById("searchBtn").onclick = runSearch;
  document.getElementById("clearFilterBtn").onclick = ()=>{
    document.getElementById("searchName").value="";
    document.getElementById("searchCompany").value="";
    document.getElementById("searchDate").value="";
    document.getElementById("searchReason").value="";
    document.querySelector("#resultsTable tbody").innerHTML="";
  };

  /* EXPORT SEARCH */
  document.getElementById("exportExcelBtn").onclick = exportSearchResultsToExcel;
  document.getElementById("exportPdfBtn").onclick = exportSearchResultsToPDF;

  /* DETAILED REPORTS */
  document.getElementById("runReportBtn").onclick = runCompanyReport;
  document.getElementById("clearReportBtn").onclick = ()=>{
    document.getElementById("companyReportStart").value="";
    document.getElementById("companyReportEnd").value="";
    document.getElementById("companyReportManual").value="";
    document.getElementById("companyReportSelect").value="";
    document.querySelector("#companyReportTable tbody").innerHTML="";
    document.getElementById("companyReportSummary").style.display="none";
  };

  document.getElementById("exportCompanyXlsBtn").onclick = exportCompanyXLS;
  document.getElementById("printCompanyPdfBtn").onclick = printCompanyPDF;

  /* ADMIN */
  document.getElementById("toggleAdminBtn").onclick = toggleAdmin;

  /* SIGNATURE VIEWER */
  document.body.addEventListener("click",e=>{
    if(!e.target.classList.contains("sig-btn")) return;
    const id=e.target.dataset.sigid;
    const url=signatureStore[id];
    if(!url){ alert("No signature."); return; }
    const w=window.open();
    w.document.write(`<img src="${url}" style="max-width:100%;">`);
  });

});
</script>

    
</body>
</html>
