<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      margin: 0;
      padding: 0;
      background: #f5f5f5;
      color: #222;
    }
    header {
      background: #ffffff;
      border-bottom: 4px solid #4F8C47;
      padding: 10px 16px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
    }
    .header-left {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .header-logo {
      height: 52px;
      border-radius: 6px;
      overflow: hidden;
      box-shadow: 0 1px 3px rgba(0,0,0,0.2);
    }
    .header-logo img {
      height: 100%;
      width: auto;
      display: block;
    }
    .header-text-main {
      font-size: 1.1rem;
      font-weight: 700;
      color: #D9A441;
      line-height: 1.2;
    }
    .header-text-sub {
      font-size: 0.85rem;
      color: #4F8C47;
    }
    .header-tagline {
      font-size: 0.75rem;
      color: #1E3A59;
      font-style: italic;
      text-align: right;
      max-width: 180px;
    }
    main {
      padding: 12px;
      max-width: 960px;
      margin: 0 auto;
    }
    .card {
      background: white;
      border-radius: 10px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.08);
      padding: 14px;
      margin-bottom: 14px;
      border-top: 3px solid #D9A441;
    }
    h2 {
      font-size: 1.05rem;
      margin-top: 0;
      color: #1E3A59;
    }
    label {
      display: block;
      margin-top: 8px;
      font-size: 0.9rem;
      font-weight: 500;
    }
    input, button, select {
      width: 100%;
      box-sizing: border-box;
      padding: 10px;
      margin-top: 4px;
      border-radius: 8px;
      border: 1px solid #ccc;
      font-size: 1rem;
    }
    button {
      background: #4F8C47;
      color: white;
      border: none;
      font-weight: 600;
      cursor: pointer;
      margin-top: 10px;
    }
    button.secondary {
      background: #1E3A59;
    }
    button:active {
      opacity: 0.85;
    }
    .row {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
    }
    .col-4 {
      flex: 1 1 30%;
    }
    .col-6 {
      flex: 1 1 48%;
    }
    .col-12 {
      flex: 1 1 100%;
    }
    @media (max-width: 600px) {
      .col-4, .col-6 {
        flex: 1 1 100%;
      }
      .header-tagline {
        display: none;
      }
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
      font-size: 0.9rem;
    }
    th, td {
      border: 1px solid #ddd;
      padding: 6px;
      text-align: left;
      white-space: nowrap;
    }
    th {
      background: #f0f0f0;
    }
    .badge {
      display: inline-block;
      padding: 2px 6px;
      border-radius: 999px;
      font-size: 0.75rem;
      background: #e3f2fd;
      color: #1E3A59;
      margin-left: 4px;
    }
    .small-text {
      font-size: 0.8rem;
      color: #666;
    }
    .actions-row {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-top: 8px;
    }
    .actions-row button {
      flex: 1 1 48%;
    }
    .pill-row {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-top: 6px;
    }
    .pill {
      padding: 4px 10px;
      border-radius: 999px;
      border: 1px solid #4F8C47;
      background: #eaf5ec;
      font-size: 0.8rem;
      cursor: pointer;
      color: #1E3A59;
    }
    .summary-box {
      margin-top: 8px;
      padding: 8px;
      border-radius: 8px;
      background: #f7f9fc;
      border: 1px solid #dde4f2;
      font-size: 0.9rem;
    }
    .tag-list {
      font-size: 0.8rem;
      margin-top: 6px;
      color: #555;
    }
    .admin-toggle-row {
      text-align: right;
      margin-bottom: 6px;
    }
    .admin-toggle-btn {
      width: auto;
      padding: 6px 10px;
      font-size: 0.75rem;
      background: #1E3A59;
    }
    #signatureWrapper {
      position: relative;
      margin-top: 6px;
    }
    #signaturePad {
      width: 100%;
      height: 140px;
      border-radius: 8px;
      border: 1px solid #ccc;
      background: #ffffff;
      touch-action: none;
      display: block;
    }
    #sigPlaceholder {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      color: #888;
      font-size: 16px;
      pointer-events: none;
    }
    .sig-btn {
      width: auto;
      padding: 4px 8px;
      font-size: 0.75rem;
      background: #4F8C47;
      color: #fff;
      border-radius: 999px;
      border: none;
      cursor: pointer;
    }
  </style>

  <script>
    // Soft clinic-style ding on submit
    function playSubmitSound() {
      var audio = new Audio("data:audio/wav;base64,UklGRoQAAABXQVZFZm10IBAAAAABAAEAESsAACJWAAACABAAZGF0YQwAAACAgICAgICAgICAgICAhISEhISEhISEhICAhISEhISEhISEhICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAg");
      audio.volume = 0.35;
      audio.play().catch(e=>console.log(e));
    }
    
    function resetForm() {
    // Clear all text inputs
    document.querySelectorAll('input[type="text"]').forEach(i => i.value = "");

    // Reset dropdowns
    document.querySelectorAll("select").forEach(s => s.selectedIndex = 0);

    // Clear ALL checkboxes (service checkboxes + "other")
    document.querySelectorAll('.service-options input[type="checkbox"]').forEach(cb => cb.checked = false);

    // Hide "Other Company" field
    const otherCompanyWrapper = document.getElementById("otherCompanyWrapper");
    const otherCompanyInput = document.getElementById("otherCompany");
    if (otherCompanyWrapper) otherCompanyWrapper.style.display = "none";
    if (otherCompanyInput) otherCompanyInput.value = "";

    // Hide "Other Reason" field
    const otherReasonWrapper = document.getElementById("otherReasonWrapper");
    const otherReasonInput = document.getElementById("otherReasonInput");
    if (otherReasonWrapper) otherReasonWrapper.style.display = "none";
    if (otherReasonInput) otherReasonInput.value = "";

    // Clear signature pad
    const clearBtn = document.getElementById("clearSigBtn");
    if (clearBtn) clearBtn.click();

    // Clear status message
    const msg = document.getElementById("submitMessage");
    if (msg) msg.textContent = "";

    alert("Form has been reset.");
}

  </script>
</head>
<body>
  <header>
    <div class="header-left">
      <div class="header-logo">
        <img src="ams_logo_cropped.jpg" alt="AMS logo" />
      </div>
      <div>
        <div class="header-text-main">AMS Check-In</div>
        <div class="header-text-sub">airport medical solutions</div>
      </div>
    </div>
    <div class="header-tagline">Your One Stop Compliance Shop</div>
  </header>
  <main>
    <!-- Public: New Check-In (donors/employees see this only) -->
    <section class="card">
      <h2>Check-In</h2>
      <div class="row">
        <div class="col-6">
          <label for="firstName">First Name</label>
          <input id="firstName" type="text" autocomplete="off" required />
        </div>
        <div class="col-6">
          <label for="lastName">Last Name</label>
          <input id="lastName" type="text" autocomplete="off" required />
        </div>
      </div>

      <div class="row">
        <div class="col-6">
          <label for="companySelect">Company (Employer)</label>
          <select id="companySelect" onchange="toggleOtherCompany()">
          </select>
          <div class="col-6" id="otherCompanyWrapper" style="display:none; margin-top:10px;">
    <label for="otherCompany">Other Company (type manually)</label>
    <input id="otherCompany" type="text" placeholder="Enter company name..." autocomplete="off" />
</div>
        
          <!-- END of Company Row -->

<!-- PASTE SERVICE CHECKBOXES HERE -->
<div class="service-options" style="margin-top:15px;">
    <label style="font-weight:bold;">Service Type</label>

    <!-- Row 1 -->
<div style="display:flex; gap:25px; margin-top:10px; align-items:center;">
    <label><input type="checkbox" name="service_drug"> Drug</label>
    <label><input type="checkbox" name="service_dna"> DNA</label>
    <label><input type="checkbox" name="service_vision"> Vision</label>
</div>

<!-- Row 2 -->
<div style="display:flex; gap:25px; margin-top:10px; align-items:center;">
    <label><input type="checkbox" name="service_alcohol"> Alcohol</label>
    <label><input type="checkbox" name="service_dot"> DOT Physical</label>

    <label>
        <input type="checkbox" id="service_other" onclick="toggleOtherInput()"> Other
    </label>
    <input
        type="text"
        id="other_reason"
        placeholder="Enter reason..."
        style="display:none; padding:4px; border:1px solid #ccc; border-radius:5px;"
    />

</div> 

<!-- END OF SERVICE CHECKBOXES -->

      <label for="reasonSelect">Reason for Testing</label>
      <select id="reasonSelect" onchange="toggleOtherReason()">
        <option value="">-- Select reason --</option>
        <option value="Pre-employment">Pre-employment</option>
        <option value="Random">Random</option>
        <option value="Reasonable suspicion">Reasonable suspicion</option>
        <option value="Post-accident">Post-accident</option>
        <option value="Return to duty">Return to duty</option>
        <option value="Follow up">Follow up</option>
        <option value="Other (personal)">Other (personal)</option>
      </select>
      <div id="otherReasonWrapper" style="display:none; margin-top:10px;">
          <label for="otherReasonInput">Other Reason (type manually)</label>
          <input id="otherReasonInput" type="text" placeholder="Enter other reason..." autocomplete="off" />
      </div>

      <label for="signaturePad">Donor Signature</label>
      <div id="signatureWrapper">
        <canvas id="signaturePad"></canvas>
        <div id="sigPlaceholder">Sign here</div>
      </div>
      <button type="button" id="clearSigBtn" class="secondary" style="width:auto; padding:6px 10px; font-size:0.8rem; margin-top:6px;">Clear Signature</button>

      <p class="small-text">
        Donor must sign above. Date &amp; time in are recorded automatically when you tap "Submit Check-In".
      </p>

      <div style="display:flex; gap:10px; margin-top:10px;">

    <!-- Submit Button (unchanged) -->
    <button id="submitBtn" style="flex:1;">
        Submit Check-In
    </button>

    <!-- Reset Button (RED) -->
    <button type="button"
            onclick="resetForm()"
            style="
                flex:1;
                background:#d9534f;
                color:white;
                padding:12px;
                border:none;
                border-radius:6px;
                font-size:1rem;
                cursor:pointer;">
        Reset Form
    </button>

</div>

      <p id="submitMessage" class="small-text"></p>
    </section>

    <!-- Small admin login control -->
    <div class="admin-toggle-row">
      <button id="toggleAdminBtn" class="admin-toggle-btn">Admin Login</button>
      <span class="small-text" id="adminStatusText"></span>
    </div>

    <!-- ADMIN-ONLY AREA (hidden until PIN is entered) -->
    <div id="adminArea" style="display:none;">
      <!-- Search Log -->
      <section class="card">
        <h2>Search Log</h2>
        <div class="row">
          <div class="col-4">
            <label for="searchName">Donor Name</label>
            <input id="searchName" type="text" placeholder="first or last name" />
          </div>
          <div class="col-4">
            <label for="searchCompany">Company Name</label>
            <input id="searchCompany" type="text" placeholder="e.g. ABC Logistics" />
          </div>
          <div class="col-4">
            <label for="searchDate">Date</label>
            <input id="searchDate" type="date" />
          </div>
        </div>
        <div class="row">
          <div class="col-6">
            <label for="searchReason">Reason for Test</label>
            <select id="searchReason">
              <option value="">Any reason</option>
              <option value="Pre-employment">Pre-employment</option>
              <option value="Random">Random</option>
              <option value="Reasonable suspicion">Reasonable suspicion</option>
              <option value="Post-accident">Post-accident</option>
              <option value="Return to duty">Return to duty</option>
              <option value="Follow up">Follow up</option>
              <option value="Other (personal)">Other (personal)</option>
            </select>
          </div>
        </div>
        <div class="actions-row">
          <button id="searchBtn">Search</button>
          <button id="clearFilterBtn" class="secondary">Clear Filters</button>
        </div>
        <p class="small-text">For AMS internal use only (billing, audits, etc.).</p>
        <div style="overflow-x:auto;">
          <table id="resultsTable">
            <thead>
              <tr>
                <th>Date</th>
                <th>Time In</th>
                <th>First</th>
                <th>Last</th>
                <th>Company</th>
                <th>Reason</th>
                <th>Services</th
                <th>Signature</th>
              </tr>
            </thead>
            <tbody>
            </tbody>
          </table>
        </div>
        <div class="actions-row">
          <button id="exportXlsBtn" class="secondary">Export ALL as Excel (.xls)</button>
          <button id="printAllBtn" class="secondary">Print ALL (PDF)</button>
        </div>
      </section>

      <!-- Reports -->
      <section class="card">
        <h2>Reports (Date Range &amp; Time In)</h2>
        <div class="pill-row">
          <span class="pill" data-range="yesterday">Yesterday</span>
          <span class="pill" data-range="thisWeek">This Week</span>
          <span class="pill" data-range="thisMonth">This Month</span>
        </div>
        <div class="row">
          <div class="col-6">
            <label for="reportStart">Start Date</label>
            <input id="reportStart" type="date" />
          </div>
          <div class="col-6">
            <label for="reportEnd">End Date</label>
            <input id="reportEnd" type="date" />
          </div>
        </div>
        <div class="row">
          <div class="col-6">
            <label for="reportTimeFrom">Time In From (optional)</label>
            <input id="reportTimeFrom" type="time" />
          </div>
          <div class="col-6">
            <label for="reportTimeTo">Time In To (optional)</label>
            <input id="reportTimeTo" type="time" />
          </div>
        </div>
        <div class="row">
          <div class="col-6">
            <label for="reportCompany">Company (optional)</label>
            <input id="reportCompany" type="text" placeholder="filter to one company" />
          </div>
          <div class="col-6">
            <label for="reportName">Donor Name (optional)</label>
            <input id="reportName" type="text" placeholder="first or last name" />
          </div>
        </div>
        <div class="row">
          <div class="col-6">
            <label for="reportReason">Reason (optional)</label>
            <select id="reportReason">
              <option value="">Any reason</option>
              <option value="Pre-employment">Pre-employment</option>
              <option value="Random">Random</option>
              <option value="Reasonable suspicion">Reasonable suspicion</option>
              <option value="Post-accident">Post-accident</option>
              <option value="Return to duty">Return to duty</option>
              <option value="Follow up">Follow up</option>
              <option value="Other (personal)">Other (personal)</option>
            </select>
          </div>
        </div>
        <div class="actions-row">
          <button id="runReportBtn">Run Report</button>
          <button id="clearReportBtn" class="secondary">Clear Report Filters</button>
        </div>

        <div id="reportSummary" class="summary-box" style="display:none;"></div>

        <div style="overflow-x:auto; margin-top:8px;">
          <table id="reportTable">
            <thead>
              <tr>
                <th>Date</th>
                <th>Time In</th>
                <th>First</th>
                <th>Last</th>
                <th>Company</th>
                <th>Reason</th>
                <th>Signature</th>
              </tr>
            </thead>
            <tbody>
            </tbody>
          </table>
        </div>

        <div class="actions-row">
          <button id="exportReportXlsBtn" class="secondary">Export REPORT as Excel (.xls)</button>
          <button id="printReportBtn" class="secondary">Print REPORT (PDF)</button>
        </div>
      </section>

      <!-- Recent Check-Ins -->
      <section class="card">
        <h2>Recent Check-Ins <span class="badge" id="countBadge">0</span></h2>
        <div style="overflow-x:auto;">
          <table id="recentTable">
            <thead>
              <tr>
                <th>Date</th>
                <th>Time In</th>
                <th>First</th>
                <th>Last</th>
                <th>Company</th>
                <th>Reason</th>
                <th>Signature</th>
              </tr>
            </thead>
            <tbody>
            </tbody>
          </table>
        </div>
      </section>

      <!-- Admin: Manage Companies -->
      <section class="card">
        <h2>Manage Company List (Admin)</h2>
        <div class="row">
          <div class="col-6">
            <label for="newCompany">Add Company Name</label>
            <input id="newCompany" type="text" placeholder="e.g. ABC Logistics" />
          </div>
          <div class="col-6" style="display:flex; align-items:flex-end;">
            <button id="addCompanyBtn">Add to List</button>
          </div>
        </div>
        <p class="small-text">
          These companies appear in the dropdown for donors. There is also an "Other" option for new companies.
        </p>
        <div class="tag-list" id="companyListDisplay"></div>
      </section>
    </div>
  </main>

  <script>

function toggleOtherInput() {
  const checkbox = document.getElementById("service_other");
  const input = document.getElementById("other_reason");

  if (checkbox.checked) {
    input.style.display = "block";
  } else {
    input.style.display = "none";
    input.value = "";
  }
}

function toggleOtherReason() {
  const select = document.getElementById("reasonSelect");
  const wrapper = document.getElementById("otherReasonWrapper");
  const input = document.getElementById("otherReasonInput");

  if (select.value.includes("Other")) {
    wrapper.style.display = "block";
    input.required = true;   // Require when visible
  } else {
    wrapper.style.display = "none";
    input.required = false;
    input.value = "";        // Clear field when not in use
  }
}

const STORAGE_KEY = 'drug_test_checkins_v2';
const COMPANY_LIST_KEY = 'drug_test_company_list_v1';
const OTHER_COMPANY_VALUE = '__OTHER__';

    // CHANGE THIS PIN IF YOU WANT A DIFFERENT ADMIN CODE
    const ADMIN_PIN = '2468';

    let lastReportRecords = [];
    let lastReportSummaryText = '';
    let adminUnlocked = false;
    let signatureStore = {};

    function loadRecords() {
      const raw = localStorage.getItem(STORAGE_KEY);
      if (!raw) return [];
      try {
        const parsed = JSON.parse(raw);
        return Array.isArray(parsed) ? parsed : [];
      } catch {
        return [];
      }
    }

    function saveRecords(records) {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(records));
    }

    function addRecord(record) {
      const records = loadRecords();
      records.push(record);
      saveRecords(records);
    }

    function getLocalDateString(d) {
      const year = d.getFullYear();
      const month = String(d.getMonth() + 1).padStart(2, '0');
      const day = String(d.getDate()).padStart(2, '0');
      return `${year}-${month}-${day}`;
    }

    function formatDateTime(isoString) {
      const d = new Date(isoString);
      if (isNaN(d.getTime())) return { date: '', time: '' };
      const date = d.toLocaleDateString();
      const time = d.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
      return { date, time };
    }

    function refreshRecentTable() {
      const tbody = document.querySelector('#recentTable tbody');
      if (!tbody) return;
      tbody.innerHTML = '';
      const records = loadRecords().slice().sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
      const badge = document.getElementById('countBadge');
      if (badge) badge.innerText = records.length;
      const recent = records.slice(0, 20);
      for (const rec of recent) {
        const { date, time } = formatDateTime(rec.timestamp);
        signatureStore[rec.id] = rec.signatureDataUrl || '';
        const sigCell = rec.signatureDataUrl
          ? `<button type="button" class="sig-btn" data-sigid="${rec.id}">View</button>`
          : '';
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${date}</td>
          <td>${time}</td>
          <td>${rec.firstName}</td>
          <td>${rec.lastName}</td>
          <td>${rec.company}</td>
          <td>${rec.reason || ''}</td>
          <td>${sigCell}</td>
        `;
        tbody.appendChild(tr);
      }
    }

    function runSearch() {
      const nameFilter = document.getElementById('searchName').value.trim().toLowerCase();
      const companyFilter = document.getElementById('searchCompany').value.trim().toLowerCase();
      const dateFilter = document.getElementById('searchDate').value;
      const reasonFilter = document.getElementById('searchReason').value;
      const tbody = document.querySelector('#resultsTable tbody');
      tbody.innerHTML = '';
      const records = loadRecords();
      const filtered = records.filter(rec => {
        let ok = true;
        if (nameFilter) {
          const fn = (rec.firstName || '').toLowerCase();
          const ln = (rec.lastName || '').toLowerCase();
          ok = ok && (fn.includes(nameFilter) || ln.includes(nameFilter));
        }
        if (companyFilter) {
          ok = ok && (rec.company || '').toLowerCase().includes(companyFilter);
        }
        if (dateFilter) {
          const d = new Date(rec.timestamp);
          if (!isNaN(d.getTime())) {
            const localDate = getLocalDateString(d);
            ok = ok && (localDate === dateFilter);
          } else {
            ok = false;
          }
        }
        if (reasonFilter) {
          ok = ok && rec.reason === reasonFilter;
        }
        return ok;
      });
      const sorted = filtered.slice().sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));
      for (const rec of sorted) {
        const { date, time } = formatDateTime(rec.timestamp);
        signatureStore[rec.id] = rec.signatureDataUrl || '';
        const sigCell = rec.signatureDataUrl
          ? `<button type="button" class="sig-btn" data-sigid="${rec.id}">View</button>`
          : '';
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${date}</td>
          <td>${time}</td>
          <td>${rec.firstName}</td>
          <td>${rec.lastName}</td>
          <td>${rec.company}</td>
          <td>${rec.reason || ''}</td>
          <td>${sigCell}</td>
        `;
        tbody.appendChild(tr);
      }
    }

    function htmlEscape(str) {
      if (str == null) return '';
      return String(str)
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;');
    }

    function buildTableHtmlFromRecords(records, includeSignature) {
      let html = '<table border="1" cellspacing="0" cellpadding="4"><thead><tr>';
      html += '<th>Date</th><th>Time In</th><th>First</th><th>Last</th><th>Company</th><th>Reason</th>';
      if (includeSignature) html += '<th>Signature</th>';
      html += '</tr></thead><tbody>';
      records.forEach(rec => {
        const dt = formatDateTime(rec.timestamp);
        html += '<tr>';
        html += '<td>' + htmlEscape(dt.date) + '</td>';
        html += '<td>' + htmlEscape(dt.time) + '</td>';
        html += '<td>' + htmlEscape(rec.firstName) + '</td>';
        html += '<td>' + htmlEscape(rec.lastName) + '</td>';
        html += '<td>' + htmlEscape(rec.company) + '</td>';
        html += '<td>' + htmlEscape(rec.reason || '') + '</td>';
        if (includeSignature) {
          html += '<td>' + (rec.signatureDataUrl ? 'Yes' : 'No') + '</td>';
        }
        html += '</tr>';
      });
      html += '</tbody></table>';
      return html;
    }

    function exportRecordsToXls(records, filename, includeSignature) {
      if (!records.length) {
        alert('No records to export.');
        return;
      }
      const tableHtml = buildTableHtmlFromRecords(records, includeSignature);
      const blob = new Blob(['\ufeff' + tableHtml], {
        type: 'application/vnd.ms-excel'
      });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }

    function printRecordsAsPdf(records, title, summaryText, includeSignature) {
      if (!records.length) {
        alert('No records to print.');
        return;
      }
      const tableHtml = buildTableHtmlFromRecords(records, includeSignature);
      const w = window.open('', '_blank');
      w.document.write('<html><head><meta charset="UTF-8"><title>' + htmlEscape(title) + '</title>');
      w.document.write('<style>body{font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,sans-serif;padding:16px;}h2{margin-top:0;}table{border-collapse:collapse;width:100%;}th,td{border:1px solid #333;padding:4px;font-size:12px;}</style>');
      w.document.write('</head><body>');
      w.document.write('<h2>' + htmlEscape(title) + '</h2>');
      if (summaryText) {
        w.document.write('<p>' + htmlEscape(summaryText) + '</p>');
      }
      w.document.write(tableHtml);
      w.document.write('</body></html>');
      w.document.close();
      w.focus();
      w.print();
    }

    function exportAllAsXls() {
      const records = loadRecords().slice().sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));
      exportRecordsToXls(records, 'ams_drug_test_full_log.xls', true);
    }

    function printAllAsPdf() {
      const records = loadRecords().slice().sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));
      printRecordsAsPdf(records, 'AMS Full Check-In Log', '', true);
    }

    function exportReportAsXls() {
      exportRecordsToXls(lastReportRecords, 'ams_drug_test_report.xls', true);
    }

    function printReportAsPdf() {
      printRecordsAsPdf(lastReportRecords, 'AMS Drug Test Report', lastReportSummaryText, true);
    }

    function loadCompanyList() {
      const raw = localStorage.getItem(COMPANY_LIST_KEY);
      if (!raw) return [];
      try {
        const parsed = JSON.parse(raw);
        return Array.isArray(parsed) ? parsed : [];
      } catch {
        return [];
      }
    }

    function saveCompanyList(list) {
      localStorage.setItem(COMPANY_LIST_KEY, JSON.stringify(list));
    }

    function renderCompanySelect() {
      const select = document.getElementById('companySelect');
      const companies = loadCompanyList();
      select.innerHTML = '';
      const defaultOpt = document.createElement('option');
      defaultOpt.value = '';
      defaultOpt.textContent = '-- Select company --';
      select.appendChild(defaultOpt);

      companies.forEach(name => {
        const opt = document.createElement('option');
        opt.value = name;
        opt.textContent = name;
        select.appendChild(opt);
      });

      const otherOpt = document.createElement('option');
      otherOpt.value = OTHER_COMPANY_VALUE;
      otherOpt.textContent = 'Other (type manually)';
      select.appendChild(otherOpt);
    }

    function renderCompanyListDisplay() {
      const container = document.getElementById('companyListDisplay');
      const companies = loadCompanyList();
      if (!companies.length) {
        container.textContent = 'No companies added yet.';
        return;
      }
      container.innerHTML = 'Current companies: ' + companies.map(c => `<span class="badge" style="margin:2px 4px 2px 0;">${c}</span>`).join('');
    }

    function setDateRangePreset(preset) {
      const startInput = document.getElementById('reportStart');
      const endInput = document.getElementById('reportEnd');
      const now = new Date();
      const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
      let startDate = today;
      let endDate = today;

      if (preset === 'yesterday') {
        startDate = new Date(today);
        startDate.setDate(startDate.getDate() - 1);
        endDate = new Date(startDate);
      } else if (preset === 'thisWeek') {
        const dayOfWeek = today.getDay();
        const diffToMonday = (dayOfWeek + 6) % 7;
        startDate = new Date(today);
        startDate.setDate(startDate.getDate() - diffToMonday);
        endDate = today;
      } else if (preset === 'thisMonth') {
        startDate = new Date(today.getFullYear(), today.getMonth(), 1);
        endDate = today;
      }

      const toStr = (d) => {
        const y = d.getFullYear();
        const m = String(d.getMonth() + 1).padStart(2, '0');
        const da = String(d.getDate()).padStart(2, '0');
        return `${y}-${m}-${da}`;
      };

      startInput.value = toStr(startDate);
      endInput.value = toStr(endDate);
    }

    function timeToMinutes(timeStr) {
      if (!timeStr) return null;
      const parts = timeStr.split(':');
      if (parts.length < 2) return null;
      const hh = parseInt(parts[0], 10);
      const mm = parseInt(parts[1], 10);
      if (isNaN(hh) || isNaN(mm)) return null;
      return hh * 60 + mm;
    }

    function runReport() {
      const startDateStr = document.getElementById('reportStart').value;
      const endDateStr = document.getElementById('reportEnd').value;
      const timeFromStr = document.getElementById('reportTimeFrom').value;
      const timeToStr = document.getElementById('reportTimeTo').value;
      const companyFilter = document.getElementById('reportCompany').value.trim().toLowerCase();
      const nameFilter = document.getElementById('reportName').value.trim().toLowerCase();
      const reasonFilter = document.getElementById('reportReason').value;

      const tbody = document.querySelector('#reportTable tbody');
      tbody.innerHTML = '';
      const summaryBox = document.getElementById('reportSummary');

      if (!startDateStr || !endDateStr) {
        summaryBox.style.display = 'block';
        summaryBox.textContent = 'Please select a start date and end date for the report.';
        lastReportRecords = [];
        lastReportSummaryText = '';
        return;
      }

      const startDate = new Date(startDateStr + 'T00:00:00');
      const endDate = new Date(endDateStr + 'T23:59:59');
      const minMinutes = timeToMinutes(timeFromStr);
      const maxMinutes = timeToMinutes(timeToStr);

      const records = loadRecords();
      const results = records.filter(rec => {
        const d = new Date(rec.timestamp);
        if (isNaN(d.getTime())) return false;
        if (d < startDate || d > endDate) return false;

        const mins = d.getHours() * 60 + d.getMinutes();
        if (minMinutes !== null && mins < minMinutes) return false;
        if (maxMinutes !== null && mins > maxMinutes) return false;

        if (companyFilter) {
          if (!(rec.company || '').toLowerCase().includes(companyFilter)) return false;
        }
        if (nameFilter) {
          const fn = (rec.firstName || '').toLowerCase();
          const ln = (rec.lastName || '').toLowerCase();
          if (!fn.includes(nameFilter) && !ln.includes(nameFilter)) return false;
        }
        if (reasonFilter) {
          if (rec.reason !== reasonFilter) return false;
        }
        return true;
      });

      const sorted = results.slice().sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));
      for (const rec of sorted) {
        const { date, time } = formatDateTime(rec.timestamp);
        signatureStore[rec.id] = rec.signatureDataUrl || '';
        const sigCell = rec.signatureDataUrl
          ? `<button type="button" class="sig-btn" data-sigid="${rec.id}">View</button>`
          : '';
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${date}</td>
          <td>${time}</td>
          <td>${rec.firstName}</td>
          <td>${rec.lastName}</td>
          <td>${rec.company}</td>
          <td>${rec.reason || ''}</td>
          <td>${sigCell}</td>
        `;
        tbody.appendChild(tr);
      }

      summaryBox.style.display = 'block';
      const count = results.length;
      let text = `Total donors in report: ${count}`;
      if (startDateStr && endDateStr) {
        text += ` | Date range: ${startDateStr} to ${endDateStr}`;
      }
      if (timeFromStr || timeToStr) {
        text += ` | Time in: ${timeFromStr || 'any'} to ${timeToStr || 'any'}`;
      }
      if (companyFilter) {
        text += ` | Company contains: "${document.getElementById('reportCompany').value.trim()}"`;
      }
      if (nameFilter) {
        text += ` | Name contains: "${document.getElementById('reportName').value.trim()}"`;
      }
      if (reasonFilter) {
        text += ` | Reason: ${reasonFilter}`;
      }
      summaryBox.textContent = text;

      lastReportRecords = sorted;
      lastReportSummaryText = text;
    }

    function clearReport() {
      document.getElementById('reportStart').value = '';
      document.getElementById('reportEnd').value = '';
      document.getElementById('reportTimeFrom').value = '';
      document.getElementById('reportTimeTo').value = '';
      document.getElementById('reportCompany').value = '';
      document.getElementById('reportName').value = '';
      document.getElementById('reportReason').value = '';
      document.querySelector('#reportTable tbody').innerHTML = '';
      const summaryBox = document.getElementById('reportSummary');
      summaryBox.style.display = 'none';
      summaryBox.textContent = '';
      lastReportRecords = [];
      lastReportSummaryText = '';
    }

    function toggleAdmin() {
      if (adminUnlocked) {
        adminUnlocked = false;
        document.getElementById('adminArea').style.display = 'none';
        document.getElementById('toggleAdminBtn').textContent = 'Admin Login';
        document.getElementById('adminStatusText').textContent = '';
        return;
      }
      const pin = prompt('Enter AMS admin PIN:');
      if (pin === ADMIN_PIN) {
        adminUnlocked = true;
        document.getElementById('adminArea').style.display = 'block';
        document.getElementById('toggleAdminBtn').textContent = 'Hide Admin Area';
        document.getElementById('adminStatusText').textContent = 'Admin mode: ON';
        refreshRecentTable();
      } else if (pin !== null) {
        alert('Incorrect PIN.');
      }
    }

    function setupSignaturePad() {
      const canvas = document.getElementById('signaturePad');
      const placeholder = document.getElementById('sigPlaceholder');
      if (!canvas) return null;
      const ctx = canvas.getContext('2d');
      let isDrawing = false;
      let lastX = 0;
      let lastY = 0;
      let hasSignature = false;

      // Resize canvas to match CSS size
      function resizeCanvas() {
        const rect = canvas.getBoundingClientRect();
        canvas.width = rect.width;
        canvas.height = rect.height;
      }
      resizeCanvas();
      window.addEventListener('resize', resizeCanvas);

      function getPos(e) {
        const rect = canvas.getBoundingClientRect();
        let clientX, clientY;
        if (e.touches && e.touches[0]) {
          clientX = e.touches[0].clientX;
          clientY = e.touches[0].clientY;
        } else {
          clientX = e.clientX;
          clientY = e.clientY;
        }
        return {
          x: clientX - rect.left,
          y: clientY - rect.top
        };
      }

      function startDrawing(e) {
        e.preventDefault();
        isDrawing = true;
        const pos = getPos(e);
        lastX = pos.x;
        lastY = pos.y;
        if (placeholder) placeholder.style.display = 'none';
      }

      function draw(e) {
        if (!isDrawing) return;
        e.preventDefault();
        const pos = getPos(e);
        ctx.strokeStyle = '#000000';
        ctx.lineWidth = 2;
        ctx.lineCap = 'round';
        ctx.beginPath();
        ctx.moveTo(lastX, lastY);
        ctx.lineTo(pos.x, pos.y);
        ctx.stroke();
        lastX = pos.x;
        lastY = pos.y;
        hasSignature = true;
      }

      function endDrawing(e) {
        if (!isDrawing) return;
        e.preventDefault();
        isDrawing = false;
      }

      canvas.addEventListener('mousedown', startDrawing);
      canvas.addEventListener('mousemove', draw);
      window.addEventListener('mouseup', endDrawing);

      canvas.addEventListener('touchstart', startDrawing, { passive: false });
      canvas.addEventListener('touchmove', draw, { passive: false });
      canvas.addEventListener('touchend', endDrawing);
      canvas.addEventListener('touchcancel', endDrawing);

      const clearBtn = document.getElementById('clearSigBtn');
      if (clearBtn) {
        clearBtn.addEventListener('click', () => {
          ctx.clearRect(0, 0, canvas.width, canvas.height);
          hasSignature = false;
          if (placeholder) placeholder.style.display = 'block';
        });
      }

      return {
        hasSignature: () => hasSignature,
        getDataUrl: () => hasSignature ? canvas.toDataURL('image/png') : '',
        clear: () => {
          ctx.clearRect(0, 0, canvas.width, canvas.height);
          hasSignature = false;
          if (placeholder) placeholder.style.display = 'block';
        }
      };
    }

    document.addEventListener('DOMContentLoaded', () => {
      if (!localStorage.getItem(COMPANY_LIST_KEY)) {
        saveCompanyList([]);
      }
      renderCompanySelect();
      renderCompanyListDisplay();

      const sigPad = setupSignaturePad();

      const submitBtn = document.getElementById('submitBtn');
      const searchBtn = document.getElementById('searchBtn');
      const clearFilterBtn = document.getElementById('clearFilterBtn');
      const exportXlsBtn = document.getElementById('exportXlsBtn');
      const printAllBtn = document.getElementById('printAllBtn');
      const exportReportXlsBtn = document.getElementById('exportReportXlsBtn');
      const printReportBtn = document.getElementById('printReportBtn');
      const msg = document.getElementById('submitMessage');
      const companySelect = document.getElementById('companySelect');
      const otherCompanyWrapper = document.getElementById('otherCompanyWrapper');
      const pills = document.querySelectorAll('.pill');
      const runReportBtn = document.getElementById('runReportBtn');
      const clearReportBtn = document.getElementById('clearReportBtn');
      const addCompanyBtn = document.getElementById('addCompanyBtn');
      const toggleAdminBtn = document.getElementById('toggleAdminBtn');

      if (toggleAdminBtn) {
        toggleAdminBtn.addEventListener('click', toggleAdmin);
      }

      if (companySelect) {
        companySelect.addEventListener('change', () => {
          if (companySelect.value === OTHER_COMPANY_VALUE) {
            otherCompanyWrapper.style.display = 'block';
          } else {
            otherCompanyWrapper.style.display = 'none';
            document.getElementById('otherCompany').value = '';
          }
        });
      }

      if (submitBtn) {
        submitBtn.addEventListener('click', () => {
          const firstName = document.getElementById('firstName').value.trim();
          const lastName = document.getElementById('lastName').value.trim();
          const companyValue = companySelect.value;
          const otherCompany = document.getElementById('otherCompany').value.trim();
          let reason = document.getElementById('reasonSelect').value;

          if (!firstName || !lastName) {
            msg.textContent = 'Please fill in first and last name.';
            msg.style.color = 'red';
            return;
          }
          if (!companyValue) {
            msg.textContent = 'Please select a company or choose "Other".';
            msg.style.color = 'red';
            return;
          }
          let company = companyValue;
          if (companyValue === OTHER_COMPANY_VALUE) {
            if (!otherCompany) {
              msg.textContent = 'Please type the other company name.';
              msg.style.color = 'red';
              return;
            }
            company = otherCompany;
          }
          // Handle manual "Other Reason"
const otherReasonInput = document.getElementById("otherReasonInput");
if (reason && reason.includes("Other")) {
    if (!otherReasonInput || otherReasonInput.value.trim() === "") {
        msg.textContent = "Please enter the reason for testing.";
        msg.style.color = "red";
        return;
    }

    // Override dropdown value with the typed reason
    reason = otherReasonInput.value.trim();
}

// Normal reason validation
if (!reason) {
    msg.textContent = 'Please select a reason for testing.';
    msg.style.color = 'red';
    return;
}

          if (!sigPad || !sigPad.hasSignature()) {
            msg.textContent = 'Please capture donor signature before submitting.';
            msg.style.color = 'red';
            return;
          }

          const signatureDataUrl = sigPad.getDataUrl();
          // Collect service checkboxes
const services = {
  drug: document.querySelector('input[name="service_drug"]').checked,
  dna: document.querySelector('input[name="service_dna"]').checked,
  vision: document.querySelector('input[name="service_vision"]').checked,
  alcohol: document.querySelector('input[name="service_alcohol"]').checked,
  dot: document.querySelector('input[name="service_dot"]').checked,
  other: document.getElementById("service_other").checked,
  otherText: document.getElementById("other_reason").value.trim()
};

          const record = {
    id: Date.now().toString(),
    firstName,
    lastName,
    company,
    reason,

    // SAVE SERVICES
    serviceTypes: services,

    signatureDataUrl,
    timestamp: new Date().toISOString()
};
document.querySelectorAll('.service-options input[type="checkbox"]').forEach(cb => {
    cb.checked = false;
});

// CLEAR OTHER REASON INPUT
document.getElementById('otherReasonInput').value = '';
document.getElementById('otherReasonWrapper').style.display = 'none';

// CLEAR SERVICE "OTHER" TEXT INPUT
document.getElementById('other_reason').value = '';
document.getElementById('other_reason').style.display = 'none';
document.getElementById('service_other').checked = false;

// CLEAR SIGNATURE
if (sigPad) sigPad.clear();

          playSubmitSound();

          document.getElementById('firstName').value = '';
          document.getElementById('lastName').value = '';
          companySelect.value = '';
          document.getElementById('otherCompany').value = '';
          otherCompanyWrapper.style.display = 'none';
          document.getElementById('reasonSelect').value = '';
          if (sigPad) sigPad.clear();

          msg.textContent = 'Check-in saved.';
          msg.style.color = 'green';
          setTimeout(() => { msg.textContent = ''; }, 3000);
        });
      }

      if (searchBtn) searchBtn.addEventListener('click', runSearch);
      if (clearFilterBtn) clearFilterBtn.addEventListener('click', () => {
        document.getElementById('searchName').value = '';
        document.getElementById('searchCompany').value = '';
        document.getElementById('searchDate').value = '';
        document.getElementById('searchReason').value = '';
        document.querySelector('#resultsTable tbody').innerHTML = '';
      });

      if (exportXlsBtn) exportXlsBtn.addEventListener('click', exportAllAsXls);
      if (printAllBtn) printAllBtn.addEventListener('click', printAllAsPdf);
      if (exportReportXlsBtn) exportReportXlsBtn.addEventListener('click', exportReportAsXls);
      if (printReportBtn) printReportBtn.addEventListener('click', printReportAsPdf);

      if (pills && pills.length) {
        pills.forEach(pill => {
          pill.addEventListener('click', () => {
            const preset = pill.getAttribute('data-range');
            setDateRangePreset(preset);
          });
        });
      }

      if (runReportBtn) runReportBtn.addEventListener('click', runReport);
      if (clearReportBtn) clearReportBtn.addEventListener('click', clearReport);

      if (addCompanyBtn) addCompanyBtn.addEventListener('click', () => {
        const input = document.getElementById('newCompany');
        const name = input.value.trim();
        if (!name) return;
        const list = loadCompanyList();
        if (!list.includes(name)) {
          list.push(name);
          list.sort((a, b) => a.localeCompare(b));
          saveCompanyList(list);
          renderCompanySelect();
          renderCompanyListDisplay();
        }
        input.value = '';
      });

      // Delegate click for signature View buttons
      document.body.addEventListener('click', (e) => {
        const target = e.target;
        if (target.classList && target.classList.contains('sig-btn')) {
          const id = target.getAttribute('data-sigid');
          const url = signatureStore[id];
          if (url) {
            const w = window.open('', '_blank');
            w.document.write('<html><head><meta charset="UTF-8"><title>Signature</title></head><body style="margin:0;padding:0;background:#f5f5f5;display:flex;align-items:center;justify-content:center;">');
            w.document.write('<img src="' + url + '" style="max-width:100%;max-height:100vh;border:1px solid #ccc;background:#fff;" />');
            w.document.write('</body></html>');
            w.document.close();
          } else {
            alert('No signature image found for this record.');
          }
        }
      });
    });
  </script>
</body>
</html>
