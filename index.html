  <!-- ===========================
     AMS CHECK-IN SYSTEM (A-3)
     PREMIUM STYLE 2 (NAVY + GOLD)
     TOP TAB NAVIGATION (STYLE A)
     =========================== -->

<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>AMS Check-In System</title>
  
</head>
/* ================================
   AMS PREMIUM STYLE 2 (NAVY + GOLD)
   ================================ */

/* COLOR PALETTE */
:root {
  --ams-navy: #1E3A59;
  --ams-gold: #D9A441;
  --ams-green: #4F8C47;
  --ams-gray-light: #f5f5f5;
  --ams-gray-mid: #ddd;
  --ams-border: #e0e0e0;
  --ams-text: #222;
  --ams-shadow: 0 2px 6px rgba(0,0,0,0.12);
  --ams-radius: 10px;
  --ams-transition: 0.25s ease;
}

/* ================================
   BODY + GLOBAL
================================ */
body {
  margin: 0;
  font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
  background: var(--ams-gray-light);
  color: var(--ams-text);
}

/* Utility */
.hidden { display: none !important; }
.visible { display: block !important; }
.bold { font-weight: 600; }

/* ================================
   HEADER
================================ */
.ams-header {
  background: #ffffff;
  padding: 12px 20px;
  border-bottom: 4px solid var(--ams-green);
  display: flex;
  align-items: center;
  justify-content: space-between;
}

.ams-header-left {
  display: flex;
  align-items: center;
  gap: 10px;
}

.ams-logo {
  height: 54px;
  border-radius: 6px;
  box-shadow: var(--ams-shadow);
}

.ams-header-title {
  font-size: 1.3rem;
  font-weight: 700;
  color: var(--ams-gold);
}

.ams-header-sub {
  font-size: 0.85rem;
  color: var(--ams-green);
}

.ams-header-tag {
  font-size: 0.8rem;
  font-style: italic;
  color: var(--ams-navy);
}

/* ================================
   CARDS
================================ */
.ams-card {
  background: #fff;
  margin: 16px auto;
  padding: 20px;
  border-radius: var(--ams-radius);
  box-shadow: var(--ams-shadow);
  max-width: 960px;
}

/* ================================
   FORM ELEMENTS
================================ */
label {
  display: block;
  margin-top: 12px;
  font-weight: 600;
  color: var(--ams-navy);
}

input, select, button {
  width: 100%;
  padding: 10px;
  margin-top: 4px;
  border-radius: 8px;
  border: 1px solid var(--ams-border);
  font-size: 1rem;
  box-sizing: border-box;
}

input:focus, select:focus {
  outline: 2px solid var(--ams-gold);
}

.note {
  font-size: 0.75rem;
  color: #666;
}

/* ================================
   BUTTONS
================================ */
.btn-primary {
  background: var(--ams-green);
  color: white;
  font-weight: 600;
  cursor: pointer;
  transition: var(--ams-transition);
}

.btn-primary:hover {
  opacity: 0.9;
}

.btn-secondary {
  background: var(--ams-navy);
  color: white;
  font-weight: 600;
  cursor: pointer;
}

.btn-secondary-small {
  width: auto;
  padding: 6px 12px;
  margin-top: 6px;
  background: var(--ams-navy);
  color: white;
  font-size: 0.8rem;
  cursor: pointer;
}

.btn-danger {
  background: #d9534f;
  color: white;
  font-weight: 700;
}

.btn-admin {
  background: var(--ams-navy);
  color: white;
  padding: 6px 12px;
  width: auto;
  border-radius: 6px;
}

/* ================================
   GRID LAYOUT
================================ */
.row {
  display: flex;
  gap: 12px;
  margin-top: 10px;
  flex-wrap: wrap;
}

.col-4 { flex: 1 1 30%; }
.col-6 { flex: 1 1 48%; }
.col-12 { flex: 1 1 100%; }

@media (max-width: 640px) {
  .col-4, .col-6 { flex: 1 1 100%; }
}

/* ================================
   SERVICE BLOCK
================================ */
.service-block {
  background: #fafafa;
  padding: 12px;
  border-radius: var(--ams-radius);
  margin-top: 12px;
  border: 1px solid var(--ams-border);
}

.service-row {
  display: flex;
  gap: 24px;
  margin-top: 10px;
  flex-wrap: wrap;
}

/* ================================
   SIGNATURE PAD
================================ */
#signatureWrapper {
  position: relative;
  border: 1px solid var(--ams-border);
  border-radius: var(--ams-radius);
  height: 150px;
  margin-top: 10px;
  background: white;
}

#signaturePad {
  width: 100%;
  height: 100%;
  touch-action: none;
}

#sigPlaceholder {
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  color: #888;
  pointer-events: none;
  font-size: 1rem;
}

/* ================================
   ADMIN LOGIN
================================ */
.admin-login-row {
  max-width: 960px;
  margin: 0 auto;
  display: flex;
  justify-content: flex-end;
  align-items: center;
  padding: 10px;
}

/* ================================
   TABS (STYLE A)
================================ */
.tab-bar {
  display: flex;
  gap: 10px;
  border-bottom: 3px solid var(--ams-gold);
  padding: 10px 0;
  margin-bottom: 20px;
}

.tab-btn {
  background: #fff;
  border: 1px solid var(--ams-border);
  padding: 10px 18px;
  border-radius: var(--ams-radius) var(--ams-radius) 0 0;
  font-weight: 600;
  cursor: pointer;
  color: var(--ams-navy);
  transition: var(--ams-transition);
}

.tab-btn.active {
  background: var(--ams-gold);
  color: white;
  border-color: var(--ams-gold);
}

/* ================================
   KPI BOXES (AMS GOLD)
================================ */
.kpi-row {
  display: flex;
  gap: 20px;
  margin-bottom: 30px;
  flex-wrap: wrap;
}

.kpi-box {
  flex: 1 1 22%;
  background: white;
  border: 2px solid var(--ams-gold);
  border-radius: var(--ams-radius);
  padding: 18px;
  text-align: center;
  box-shadow: var(--ams-shadow);
}

.kpi-title {
  color: var(--ams-gold);
  font-size: 0.9rem;
  font-weight: 700;
}

.kpi-value {
  color: var(--ams-navy);
  font-size: 2rem;
  font-weight: 900;
  margin-top: 8px;
}

/* ================================
   CHART BLOCKS
================================ */
.chart-block {
  background: white;
  padding: 18px;
  border-radius: var(--ams-radius);
  box-shadow: var(--ams-shadow);
  margin-bottom: 30px;
}

.chart-block h3 {
  color: var(--ams-navy);
  margin-bottom: 12px;
}

/* ================================
   TABLES
================================ */
.ams-table {
  width: 100%;
  border-collapse: collapse;
  margin-top: 16px;
  box-shadow: var(--ams-shadow);
  overflow-x: auto;
}

.ams-table th {
  background: var(--ams-navy);
  color: white;
  padding: 10px;
  font-size: 0.85rem;
  position: sticky;
  top: 0;
  z-index: 2;
}

.ams-table td {
  padding: 8px;
  border-bottom: 1px solid var(--ams-gray-mid);
}

.ams-table tr:nth-child(even) {
  background: #f7f7f7;
}

.badge {
  background: var(--ams-gold);
  color: white;
  padding: 2px 8px;
  border-radius: 20px;
  font-size: 0.8rem;
}

/* ================================
   MESSAGE TEXT
================================ */
.msg {
  font-size: 0.9rem;
  margin-top: 10px;
}

/* ================================
   COMPANY MANAGER
================================ */
.search-bar {
  margin-top: 12px;
}

.company-item {
  background: #fff;
  padding: 10px;
  border: 1px solid var(--ams-border);
  border-radius: var(--ams-radius);
  box-shadow: var(--ams-shadow);
  margin-top: 8px;
  display: flex;
  justify-content: space-between;
}

.company-actions button {
  margin-left: 8px;
}

/* ================================
   REPORT BOX
================================ */
.report-box {
  background: #f7f9fc;
  padding: 12px;
  border-radius: var(--ams-radius);
  border: 1px solid var(--ams-border);
  margin-top: 12px;
}

<body>

<!-- ---------------------------
     HEADER BAR
---------------------------- -->
<header class="ams-header">
  <div class="ams-header-left">
    <img src="ams_logo_cropped.jpg" class="ams-logo" />
    <div>
      <div class="ams-header-title">AMS Check-In</div>
      <div class="ams-header-sub">airport medical solutions</div>
    </div>
  </div>

  <div class="ams-header-tag">Your One Stop Compliance Shop</div>
</header>

<!-- ---------------------------
     PUBLIC CHECK-IN SECTION
---------------------------- -->
<section id="publicCheckin" class="ams-card">

  <h2>Check-In</h2>

  <div class="row">
    <div class="col-6">
      <label>First Name</label>
      <input id="firstName" type="text" autocomplete="off" />
    </div>

    <div class="col-6">
      <label>Last Name</label>
      <input id="lastName" type="text" autocomplete="off" />
    </div>
  </div>

  <label>Company (Employer)</label>
  <select id="companySelect"></select>

  <div id="otherCompanyWrapper" class="hidden">
    <label>Other Company</label>
    <input id="otherCompany" type="text" placeholder="Enter company name..." />
  </div>

  <!-- SERVICES -->
  <div class="service-block">
    <label class="bold">Service Type</label>

    <div class="service-row">
      <label><input type="checkbox" id="svc_drug"> Drug</label>
      <label><input type="checkbox" id="svc_dna"> DNA</label>
      <label><input type="checkbox" id="svc_vision"> Vision</label>
    </div>

    <div class="service-row">
      <label><input type="checkbox" id="svc_alcohol"> Alcohol</label>
      <label><input type="checkbox" id="svc_dot"> DOT Physical</label>

      <label><input type="checkbox" id="svc_other"> Other</label>
      <input id="svc_other_text" type="text" placeholder="Enter reason..." class="hidden" />
    </div>
  </div>

  <!-- REASON -->
  <label>Reason for Testing</label>
  <select id="reasonSelect">
    <option value="">-- Select --</option>
    <option value="Pre-employment">Pre-employment</option>
    <option value="Random">Random</option>
    <option value="Reasonable suspicion">Reasonable suspicion</option>
    <option value="Post-accident">Post-accident</option>
    <option value="Return to duty">Return to duty</option>
    <option value="Follow up">Follow up</option>
    <option value="Other (personal)">Other (personal)</option>
  </select>

  <div id="otherReasonWrapper" class="hidden">
    <label>Other Reason</label>
    <input id="otherReasonInput" type="text" placeholder="Type reason..." />
  </div>

  <!-- SIGNATURE -->
  <label>Donor Signature</label>
  <div id="signatureWrapper">
    <canvas id="signaturePad"></canvas>
    <div id="sigPlaceholder">Sign here</div>
  </div>

  <button id="clearSigBtn" class="btn-secondary-small">Clear Signature</button>

  <p class="note">Signature required. Date/time recorded automatically.</p>

  <div class="row">
    <button id="submitBtn" class="btn-primary">Submit Check-In</button>
    <button id="resetBtn" class="btn-danger">Reset</button>
  </div>

  <p id="submitMessage" class="msg"></p>

</section>


<!-- ---------------------------
     ADMIN LOGIN BUTTON
---------------------------- -->
<div class="admin-login-row">
  <button id="toggleAdminBtn" class="btn-admin">Admin Login</button>
  <span id="adminStatusText"></span>
</div>

<!-- ---------------------------
     ADMIN AREA (Hidden until PIN)
---------------------------- -->
<div id="adminArea" class="hidden">

  <!-- TOP TAB NAVIGATION -->
  <div class="tab-bar">
    <button class="tab-btn active" data-tab="dashboardTab">Dashboard</button>
    <button class="tab-btn" data-tab="searchTab">Search Log</button>
    <button class="tab-btn" data-tab="reportsTab">Reports</button>
    <button class="tab-btn" data-tab="recentTab">Recent Check-Ins</button>
    <button class="tab-btn" data-tab="companiesTab">Manage Companies</button>
  </div>

  <!-- ---------------------------
       TAB: DASHBOARD
  ---------------------------- -->
  <section id="dashboardTab" class="tab-content visible">

    <h2>Dashboard</h2>

    <!-- KPI ROW -->
    <div class="kpi-row">

      <div class="kpi-box">
        <div class="kpi-title">TOTAL CHECK-INS</div>
        <div class="kpi-value" id="kpi_total">0</div>
      </div>

      <div class="kpi-box">
        <div class="kpi-title">TODAY</div>
        <div class="kpi-value" id="kpi_today">0</div>
      </div>

      <div class="kpi-box">
        <div class="kpi-title">THIS WEEK</div>
        <div class="kpi-value" id="kpi_week">0</div>
      </div>

      <div class="kpi-box">
        <div class="kpi-title">THIS MONTH</div>
        <div class="kpi-value" id="kpi_month">0</div>
      </div>

    </div>

    <!-- CHARTS -->
    <div class="chart-block">
      <h3>Daily Check-Ins (Last 30 Days)</h3>
      <canvas id="chart_daily" height="220"></canvas>
    </div>

    <div class="chart-block">
      <h3>Top 5 Companies</h3>
      <canvas id="chart_companies" height="220"></canvas>
    </div>

    <div class="chart-block">
      <h3>Service Type Breakdown</h3>
      <canvas id="chart_services" height="220"></canvas>
    </div>

  </section>

  <!-- ---------------------------
       TAB: SEARCH LOG
  ---------------------------- -->
  <section id="searchTab" class="tab-content">

    <h2>Search Log</h2>

    <div class="row">
      <div class="col-4">
        <label>Donor Name</label>
        <input id="searchName" type="text" />
      </div>

      <div class="col-4">
        <label>Company</label>
        <input id="searchCompany" type="text" />
      </div>

      <div class="col-4">
        <label>Date</label>
        <input id="searchDate" type="date" />
      </div>
    </div>

    <label>Reason</label>
    <select id="searchReason">
      <option value="">Any</option>
      <option value="Pre-employment">Pre-employment</option>
      <option value="Random">Random</option>
      <option value="Reasonable suspicion">Reasonable suspicion</option>
      <option value="Post-accident">Post-accident</option>
      <option value="Return to duty">Return to duty</option>
      <option value="Follow up">Follow up</option>
      <option value="Other (personal)">Other (personal)</option>
    </select>

    <div class="row">
      <button id="searchBtn" class="btn-primary">Search</button>
      <button id="clearFilterBtn" class="btn-secondary">Clear</button>
    </div>

    <table class="ams-table" id="resultsTable">
      <thead>
        <tr>
          <th>Date</th>
          <th>Time In</th>
          <th>First</th>
          <th>Last</th>
          <th>Company</th>
          <th>Reason</th>
          <th>Services</th>
          <th>Signature</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>

    <div class="row">
      <button id="exportXlsBtn" class="btn-secondary">Export ALL (.xls)</button>
      <button id="printAllBtn" class="btn-secondary">Print ALL</button>
    </div>

  </section>


  <!-- ---------------------------
       TAB: REPORTS
  ---------------------------- -->
  <section id="reportsTab" class="tab-content">

    <h2>Reports</h2>

    <div class="row">
      <div class="col-6">
        <label>Start Date</label>
        <input id="reportStart" type="date" />
      </div>

      <div class="col-6">
        <label>End Date</label>
        <input id="reportEnd" type="date" />
      </div>
    </div>

    <label>Time In From</label>
    <input id="reportTimeFrom" type="time" />

    <label>Time In To</label>
    <input id="reportTimeTo" type="time" />

    <label>Company</label>
    <input id="reportCompany" type="text" />

    <label>Donor Name</label>
    <input id="reportName" type="text" />

    <label>Reason</label>
    <select id="reportReason">
      <option value="">Any</option>
      <option value="Pre-employment">Pre-employment</option>
      <option value="Random">Random</option>
      <option value="Reasonable suspicion">Reasonable suspicion</option>
      <option value="Post-accident">Post-accident</option>
      <option value="Return to duty">Return to duty</option>
      <option value="Follow up">Follow up</option>
      <option value="Other (personal)">Other (personal)</option>
    </select>

    <div class="row">
      <button id="runReportBtn" class="btn-primary">Run Report</button>
      <button id="clearReportBtn" class="btn-secondary">Clear</button>
    </div>

    <div id="reportSummary" class="report-box hidden"></div>

    <table class="ams-table" id="reportTable">
      <thead>
        <tr>
          <th>Date</th>
          <th>Time In</th>
          <th>First</th>
          <th>Last</th>
          <th>Company</th>
          <th>Reason</th>
          <th>Services</th>
          <th>Signature</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>

    <div class="row">
      <button id="exportReportXlsBtn" class="btn-secondary">Export REPORT (.xls)</button>
      <button id="printReportBtn" class="btn-secondary">Print REPORT</button>
    </div>

  </section>


  <!-- ---------------------------
       TAB: RECENT CHECK-INS
  ---------------------------- -->
  <section id="recentTab" class="tab-content">

    <h2>
      Recent Check-Ins
      <span class="badge" id="countBadge">0</span>
    </h2>

    <table class="ams-table" id="recentTable">
      <thead>
        <tr>
          <th>Date</th>
          <th>Time In</th>
          <th>First</th>
          <th>Last</th>
          <th>Company</th>
          <th>Reason</th>
          <th>Services</th>
          <th>Signature</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>

  </section>


  <!-- ---------------------------
       TAB: MANAGE COMPANIES
  ---------------------------- -->
  <section id="companiesTab" class="tab-content">

    <h2>Manage Company List</h2>

    <div class="row">
      <div class="col-6">
        <label>Add Company</label>
        <input id="newCompany" type="text" />
      </div>

      <div class="col-6">
        <button id="addCompanyBtn" class="btn-primary">Add</button>
      </div>
    </div>

    <input id="companySearch" type="text" placeholder="Search companies..." class="search-bar" />

    <div id="companyListDisplay"></div>

  </section>

</div>
  
  <script>
/* ============================================================
   PART 3A — CORE SYSTEM ENGINE
   Handles:
   - LocalStorage record saving/loading
   - Validation logic
   - Service + reason handling
   - Reset handling
   - Company list save/load/render
   ============================================================ */

/* -----------------------------
   STORAGE KEYS
----------------------------- */
const STORAGE_KEY = "ams_records_v3";
const COMPANY_KEY = "ams_companies_v2";

/* -----------------------------
   LOAD EXISTING RECORDS
----------------------------- */
function loadRecords() {
  const raw = localStorage.getItem(STORAGE_KEY);
  if (!raw) return [];
  try {
    const data = JSON.parse(raw);
    return Array.isArray(data) ? data : [];
  } catch {
    return [];
  }
}

/* -----------------------------
   SAVE ALL RECORDS BACK
----------------------------- */
function saveRecords(records) {
  localStorage.setItem(STORAGE_KEY, JSON.stringify(records));
}

/* -----------------------------
   ADD A SINGLE NEW RECORD
----------------------------- */
function addRecord(rec) {
  const all = loadRecords();
  all.push(rec);
  saveRecords(all);
}

/* -----------------------------
   COMPANY LIST LOADING/SAVING
----------------------------- */
function loadCompanyList() {
  const raw = localStorage.getItem(COMPANY_KEY);
  if (!raw) return [];
  try {
    const data = JSON.parse(raw);
    return Array.isArray(data) ? data : [];
  } catch {
    return [];
  }
}

function saveCompanyList(list) {
  localStorage.setItem(COMPANY_KEY, JSON.stringify(list));
}

/* -----------------------------
   RENDER SELECT DROPDOWN
----------------------------- */
function renderCompanySelect() {
  const list = loadCompanyList();
  const sel = document.getElementById("companySelect");

  sel.innerHTML = "";
  const opt0 = document.createElement("option");
  opt0.value = "";
  opt0.textContent = "-- Select company --";
  sel.appendChild(opt0);

  list.forEach(c => {
    const o = document.createElement("option");
    o.value = c;
    o.textContent = c;
    sel.appendChild(o);
  });

  // last option "Other"
  const o2 = document.createElement("option");
  o2.value = "__OTHER__";
  o2.textContent = "Other (type manually)";
  sel.appendChild(o2);
}

/* -----------------------------
   RENDER COMPANY LIST ON ADMIN PAGE
----------------------------- */
function renderCompanyListDisplay() {
  const list = loadCompanyList();
  const search = document.getElementById("companySearch").value.toLowerCase();
  const box = document.getElementById("companyListDisplay");

  if (!list.length) {
    box.innerHTML = "<p>No companies added yet.</p>";
    return;
  }

  const filtered = list.filter(c => c.toLowerCase().includes(search));

  box.innerHTML = filtered
    .map(c => `
      <div class="company-item">
        <span>${c}</span>
        <div class="company-actions">
          <button class="btn-secondary-small editCompany" data-name="${c}">Edit</button>
          <button class="btn-danger deleteCompany" data-name="${c}">Delete</button>
        </div>
      </div>
    `)
    .join("");

  // Attach edit/delete handlers
  document.querySelectorAll(".editCompany").forEach(btn => {
    btn.onclick = () => {
      const old = btn.dataset.name;
      const newName = prompt("Edit company name:", old);
      if (!newName || !newName.trim()) return;

      const list2 = loadCompanyList();
      const clean = newName.trim();

      // prevent duplicates
      if (list2.includes(clean) && clean !== old) {
        alert("This company already exists.");
        return;
      }

      const idx = list2.indexOf(old);
      if (idx !== -1) {
        list2[idx] = clean;
        list2.sort();
        saveCompanyList(list2);
        renderCompanySelect();
        renderCompanyListDisplay();
      }
    };
  });

  document.querySelectorAll(".deleteCompany").forEach(btn => {
    btn.onclick = () => {
      const name = btn.dataset.name;
      if (!confirm(`Delete "${name}" from company list?`)) return;
      let list2 = loadCompanyList();
      list2 = list2.filter(x => x !== name);
      saveCompanyList(list2);
      renderCompanySelect();
      renderCompanyListDisplay();
    };
  });
}

/* -----------------------------
   UTILITY — DATE HELPERS
----------------------------- */
function formatDate(d) {
  return d.toLocaleDateString();
}
function formatTime(d) {
  return d.toLocaleTimeString([], { hour: "2-digit", minute: "2-digit" });
}

/* Convert ISO → readable */
function convertTimestamp(ts) {
  const d = new Date(ts);
  if (isNaN(d)) return { date: "", time: "" };
  return {
    date: formatDate(d),
    time: formatTime(d)
  };
}

/* -----------------------------
   VALIDATE + SUBMIT RECORD
----------------------------- */
function submitCheckin() {
  const msg = document.getElementById("submitMessage");

  const first = document.getElementById("firstName").value.trim();
  const last = document.getElementById("lastName").value.trim();
  const companySel = document.getElementById("companySelect").value;
  let company = companySel;
  const otherCompany = document.getElementById("otherCompany").value.trim();
  let reason = document.getElementById("reasonSelect").value;
  const otherReason = document.getElementById("otherReasonInput").value.trim();

  // Required: first/last
  if (!first || !last) {
    msg.textContent = "Please enter first and last name.";
    msg.style.color = "red";
    return;
  }

  // Company logic
  if (!companySel) {
    msg.textContent = "Please select a company.";
    msg.style.color = "red";
    return;
  }
  if (companySel === "__OTHER__") {
    if (!otherCompany) {
      msg.textContent = "Please type the company name.";
      msg.style.color = "red";
      return;
    }
    company = otherCompany;
  }

  // Reason logic
  if (!reason) {
    msg.textContent = "Please select a reason for testing.";
    msg.style.color = "red";
    return;
  }

  if (reason.includes("Other")) {
    if (!otherReason) {
      msg.textContent = "Please provide the other reason.";
      msg.style.color = "red";
      return;
    }
    reason = otherReason;
  }

  // Service selection validation
  const services = {
    drug: document.getElementById("svc_drug").checked,
    dna: document.getElementById("svc_dna").checked,
    vision: document.getElementById("svc_vision").checked,
    alcohol: document.getElementById("svc_alcohol").checked,
    dot: document.getElementById("svc_dot").checked,
    other: document.getElementById("svc_other").checked,
    otherText: document.getElementById("svc_other_text").value.trim()
  };

  // At least one service must be selected
  const anyService = Object.values(services).some(v => v === true) || (services.otherText.length > 0);
  if (!anyService) {
    msg.textContent = "Please select at least one service.";
    msg.style.color = "red";
    return;
  }

  // If “other service” but no text
  if (services.other && !services.otherText) {
    msg.textContent = "Please describe the 'Other' service.";
    msg.style.color = "red";
    return;
  }

  // Signature required
  if (!signaturePad || !signaturePad.hasSignature()) {
    msg.textContent = "Please capture signature before submitting.";
    msg.style.color = "red";
    document.getElementById("signatureWrapper").scrollIntoView({ behavior: "smooth" });
    return;
  }

  const signatureDataUrl = signaturePad.getDataURL();

  // Build record object
  const rec = {
    id: crypto.randomUUID(),
    firstName: first,
    lastName: last,
    company,
    reason,
    services,
    signatureDataUrl,
    timestamp: new Date().toISOString()
  };

  addRecord(rec);

  msg.textContent = "Check-in saved successfully.";
  msg.style.color = "green";

  // Reset UI
  resetFormUI();
}

/* -----------------------------
   RESET ALL FIELDS
----------------------------- */
function resetFormUI() {
  document.getElementById("firstName").value = "";
  document.getElementById("lastName").value = "";
  document.getElementById("companySelect").value = "";
  document.getElementById("otherCompany").value = "";
  document.getElementById("otherCompanyWrapper").classList.add("hidden");

  // Reason reset
  document.getElementById("reasonSelect").value = "";
  document.getElementById("otherReasonInput").value = "";
  document.getElementById("otherReasonWrapper").classList.add("hidden");

  // Services reset
  ["svc_drug","svc_dna","svc_vision","svc_alcohol","svc_dot","svc_other"].forEach(id => {
    document.getElementById(id).checked = false;
  });
  document.getElementById("svc_other_text").value = "";
  document.getElementById("svc_other_text").classList.add("hidden");

  // Signature reset
  if (signaturePad) signaturePad.clear();
}
/* ============================================================
   PART 3B — DASHBOARD ENGINE + CHARTS
   ============================================================ */

/* -------------------------
   GET RECORDS SORTED
-------------------------- */
function getAllRecordsSorted() {
  return loadRecords().sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));
}

/* -------------------------
   DASHBOARD KPI CALCULATIONS
-------------------------- */
function updateDashboardKPIs() {
  const records = getAllRecordsSorted();
  if (!records.length) {
    document.getElementById("kpi_today").textContent = 0;
    document.getElementById("kpi_week").textContent = 0;
    document.getElementById("kpi_month").textContent = 0;
    return;
  }

  const now = new Date();
  const todayStr = now.toLocaleDateString();

  // WEEK RANGE (Mon–Sun)
  const dayOfWeek = now.getDay(); // 0 = Sun
  const diffToMonday = (dayOfWeek === 0 ? 6 : dayOfWeek - 1);
  const monday = new Date(now);
  monday.setDate(now.getDate() - diffToMonday);
  monday.setHours(0, 0, 0, 0);

  // MONTH RANGE
  const firstOfMonth = new Date(now.getFullYear(), now.getMonth(), 1);

  let todayCount = 0;
  let weekCount = 0;
  let monthCount = 0;

  records.forEach(r => {
    const d = new Date(r.timestamp);
    const dStr = d.toLocaleDateString();

    if (dStr === todayStr) todayCount++;
    if (d >= monday) weekCount++;
    if (d >= firstOfMonth) monthCount++;
  });

  document.getElementById("kpi_today").textContent = todayCount;
  document.getElementById("kpi_week").textContent = weekCount;
  document.getElementById("kpi_month").textContent = monthCount;
}

/* ============================================================
   DAILY 30-DAY CHECK-IN CHART
============================================================ */
function build30DayData() {
  const records = loadRecords();
  const today = new Date();
  const map = {};

  // Initialize map with 30 days back
  for (let i = 29; i >= 0; i--) {
    const d = new Date();
    d.setDate(today.getDate() - i);
    const key = d.toLocaleDateString();
    map[key] = 0;
  }

  // Count
  records.forEach(r => {
    const d = new Date(r.timestamp).toLocaleDateString();
    if (map[d] !== undefined) map[d]++;
  });

  return Object.entries(map); // [ [dateString, count], ... ]
}

/* ============================================================
   TOP 5 COMPANIES (COUNT OF CHECK-INS)
============================================================ */
function buildTopCompanies() {
  const map = {};
  const records = loadRecords();

  records.forEach(r => {
    const c = r.company || "Unknown";
    map[c] = (map[c] || 0) + 1;
  });

  // Convert to list, sort
  const arr = Object.entries(map); // [company, count]
  arr.sort((a, b) => b[1] - a[1]);

  return arr.slice(0, 5);
}

/* ============================================================
   SERVICE BREAKDOWN
============================================================ */
function buildServiceBreakdown() {
  const svcMap = {
    Drug: 0,
    DNA: 0,
    Vision: 0,
    Alcohol: 0,
    "DOT Physical": 0,
    Other: 0
  };

  const records = loadRecords();

  records.forEach(r => {
    if (!r.services) return;
    if (r.services.drug) svcMap.Drug++;
    if (r.services.dna) svcMap.DNA++;
    if (r.services.vision) svcMap.Vision++;
    if (r.services.alcohol) svcMap.Alcohol++;
    if (r.services.dot) svcMap["DOT Physical"]++;
    if (r.services.other || r.services.otherText) svcMap.Other++;
  });

  return svcMap;
}

/* ============================================================
   GENERIC CANVAS BAR CHART DRAWER
============================================================ */
function drawBarChart(canvasId, labels, values, color = "#1E3A59") {
  const canvas = document.getElementById(canvasId);
  if (!canvas) return;

  const ctx = canvas.getContext("2d");
  const W = canvas.width;
  const H = canvas.height;

  ctx.clearRect(0, 0, W, H);

  const maxValue = Math.max(...values, 1);
  const barWidth = W / values.length * 0.6;
  const gap = W / values.length * 0.4;

  // Animated bars
  let progress = 0;

  function animate() {
    progress += 0.05;
    if (progress > 1) progress = 1;

    ctx.clearRect(0, 0, W, H);

    values.forEach((v, i) => {
      const barHeight = (v / maxValue) * (H - 20) * progress;
      const x = i * (barWidth + gap) + gap / 2;
      const y = H - barHeight - 10;

      // Draw bar
      ctx.fillStyle = color;
      ctx.fillRect(x, y, barWidth, barHeight);

      // Labels
      ctx.fillStyle = "#000";
      ctx.font = "12px sans-serif";
      ctx.fillText(labels[i], x, H - 2);
    });

    if (progress < 1) requestAnimationFrame(animate);
  }

  animate();
}

/* ============================================================
   LINE CHART FOR 30-DAY HISTORY
============================================================ */
function drawLineChart(canvasId, labels, values) {
  const canvas = document.getElementById(canvasId);
  if (!canvas) return;

  const ctx = canvas.getContext("2d");
  const W = canvas.width;
  const H = canvas.height;

  ctx.clearRect(0, 0, W, H);

  const maxValue = Math.max(...values, 1);
  const stepX = W / (values.length - 1);

  let progress = 0;

  function animate() {
    progress += 0.04;
    if (progress > 1) progress = 1;

    ctx.clearRect(0, 0, W, H);

    ctx.beginPath();
    ctx.strokeStyle = "#1E3A59";
    ctx.lineWidth = 2;

    values.forEach((v, i) => {
      const x = i * stepX;
      const y = H - (v / maxValue) * (H - 20) * progress - 10;

      if (i === 0) ctx.moveTo(x, y);
      else ctx.lineTo(x, y);
    });

    ctx.stroke();

    if (progress < 1) requestAnimationFrame(animate);
  }

  animate();
}

/* ============================================================
   REFRESH ALL CHARTS
============================================================ */
function refreshCharts() {
  /* ---- 30 DAY HISTORY ---- */
drawLineChart("chart_daily", labels30, values30);
drawBarChart("chart_companies", labelsTop, valuesTop, "#D9A441");
drawBarChart("chart_services", labelsSvc, valuesSvc, "#4F8C47");

}

/* ============================================================
   DASHBOARD REFRESH (KPIs + CHARTS)
============================================================ */
function refreshDashboard() {
  updateDashboardKPIs();
  refreshCharts();
}
/* ============================================================
   PART 3C — SIGNATURE PAD + ADMIN LOGIN + TAB SYSTEM
============================================================ */

/* -------------------------
   SIGNATURE PAD ENGINE
-------------------------- */
let signaturePad = null;

function initSignaturePad() {
  const canvas = document.getElementById("signaturePad");
  if (!canvas) return;

  const ctx = canvas.getContext("2d");
  let drawing = false;
  let last = { x: 0, y: 0 };
  let signed = false;

  function resize() {
    const rect = canvas.getBoundingClientRect();
    canvas.width = rect.width;
    canvas.height = rect.height;
    ctx.lineWidth = 2;
    ctx.lineCap = "round";
  }
  resize();
  window.addEventListener("resize", resize);

  function getPos(e) {
    const r = canvas.getBoundingClientRect();
    const t = e.touches ? e.touches[0] : e;
    return { x: t.clientX - r.left, y: t.clientY - r.top };
  }

  function start(e) {
    drawing = true;
    const p = getPos(e);
    last = p;
    signed = true;
    document.getElementById("sigPlaceholder").style.display = "none";
  }

  function move(e) {
    if (!drawing) return;
    const p = getPos(e);
    ctx.beginPath();
    ctx.moveTo(last.x, last.y);
    ctx.lineTo(p.x, p.y);
    ctx.stroke();
    last = p;
  }

  function end() {
    drawing = false;
  }

  canvas.addEventListener("mousedown", start);
  canvas.addEventListener("mousemove", move);
  window.addEventListener("mouseup", end);

  canvas.addEventListener("touchstart", start, { passive: false });
  canvas.addEventListener("touchmove", move, { passive: false });
  canvas.addEventListener("touchend", end);

  document.getElementById("clearSigBtn").onclick = () => {
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    signed = false;
    document.getElementById("sigPlaceholder").style.display = "block";
  };

  signaturePad = {
    hasSignature: () => signed,
    getDataURL: () => canvas.toDataURL("image/png"),
    clear: () => {
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      signed = false;
      document.getElementById("sigPlaceholder").style.display = "block";
    }
  };
}

/* -------------------------
   ADMIN LOGIN SYSTEM
-------------------------- */
let adminUnlocked = false;
const ADMIN_PIN = "2468";

function adminLogin() {
  if (adminUnlocked) {
    adminUnlocked = false;
    document.getElementById("adminTabs").classList.add("hidden");
    alert("Admin mode disabled.");
    return;
  }

  const pin = prompt("Enter AMS Admin PIN:");
  if (pin === ADMIN_PIN) {
    adminUnlocked = true;
    document.getElementById("adminTabs").classList.remove("hidden");
    document.getElementById("adminStatus").textContent = "Admin Mode: ON";
    refreshDashboard();
  } else if (pin !== null) {
    alert("Incorrect PIN.");
  }
}

/* -------------------------
   TAB NAVIGATION SYSTEM
-------------------------- */
function showTab(tabId) {
  // Hide all tabs
  document.querySelectorAll(".tab-content").forEach(c => c.classList.add("hidden"));

  // Remove highlight from all tab buttons
  document.querySelectorAll(".tab-btn").forEach(b => b.classList.remove("active-tab"));

  // Show selected tab
  document.getElementById(tabId).classList.remove("hidden");

  // Highlight tab button
  const btn = document.querySelector(`[data-tab="${tabId}"]`);
  if (btn) btn.classList.add("active-tab");

  // Refresh dashboard when opened
  if (tabId === "dashboardTab") refreshDashboard();
}

/* -------------------------
   OTHER COMPANY (Show/Hide)
-------------------------- */
document.getElementById("companySelect").addEventListener("change", () => {
  const val = document.getElementById("companySelect").value;
  const wrapper = document.getElementById("otherCompanyWrapper");

  if (val === "__OTHER__") wrapper.classList.remove("hidden");
  else wrapper.classList.add("hidden");
});

/* -------------------------
   OTHER REASON (Show/Hide)
-------------------------- */
document.getElementById("reasonSelect").addEventListener("change", () => {
  const val = document.getElementById("reasonSelect").value;
  const wrap = document.getElementById("otherReasonWrapper");

  if (val.includes("Other")) wrap.classList.remove("hidden");
  else wrap.classList.add("hidden");
});

/* -------------------------
   SERVICE "OTHER" TEXT FIELD
-------------------------- */
document.getElementById("svc_other").addEventListener("change", () => {
  const box = document.getElementById("svc_other_text");
  if (document.getElementById("svc_other").checked)
    box.classList.remove("hidden");
  else
    box.classList.add("hidden");
});
/* ============================================================
   PART 4 — INITIALIZATION (BOOT SEQUENCE)
============================================================ */

document.addEventListener("DOMContentLoaded", () => {

  /* -------------------------
     INIT SIGNATURE PAD
  -------------------------- */
  initSignaturePad();

  /* -------------------------
     LOAD COMPANY LIST INTO SELECT
  -------------------------- */
  renderCompanySelect();
  renderCompanyListDisplay();

  /* -------------------------
     TAB BUTTONS
  -------------------------- */
  document.querySelectorAll(".tab-btn").forEach(btn => {
    btn.addEventListener("click", () => {
      const tab = btn.dataset.tab;
      showTab(tab);
    });
  });

    /* -------------------------
     DEFAULT TAB
  -------------------------- */
  showTab("dashboardTab");

  /* -------------------------
     ADMIN LOGIN BUTTON
  -------------------------- */
  const adminBtn = document.getElementById("toggleAdminBtn");
  if (adminBtn)
    adminBtn.addEventListener("click", adminLogin);

  /* -------------------------
     SUBMIT CHECK-IN
  -------------------------- */
  const submitBtn = document.getElementById("submitBtn");
  if (submitBtn)
    submitBtn.addEventListener("click", submitCheckin);

  /* -------------------------
     RESET BUTTON
  -------------------------- */
  const resetBtn = document.getElementById("resetBtn");
  if (resetBtn)
    resetBtn.addEventListener("click", resetFormUI);

  /* -------------------------
     SEARCH BUTTON
  -------------------------- */
  const searchBtn = document.getElementById("searchBtn");
  if (searchBtn)
    searchBtn.addEventListener("click", runSearch);

  /* -------------------------
     REPORT BUTTON
  -------------------------- */
  const reportBtn = document.getElementById("runReportBtn");
  if (reportBtn)
    reportBtn.addEventListener("click", runReport);

  /* -------------------------
     EXPORT ALL XLS
  -------------------------- */
  const exportAllBtn = document.getElementById("exportXlsBtn");
  if (exportAllBtn)
    exportAllBtn.addEventListener("click", exportAllAsXls);

  /* -------------------------
     EXPORT REPORT XLS
  -------------------------- */
  const exportReportBtn = document.getElementById("exportReportXlsBtn");
  if (exportReportBtn)
    exportReportBtn.addEventListener("click", exportReportAsXls);

  /* -------------------------
     INITIAL DASHBOARD LOAD
  -------------------------- */
  refreshDashboard();

}); // END DOMContentLoaded

  /* -------------------------
     DEFAULT TAB
  -------------------------- */*
</script>
  
</body>
</html>
